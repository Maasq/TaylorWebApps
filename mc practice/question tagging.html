<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Question Tagger</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; max-width: 900px; margin: 20px auto; padding: 20px; background: #f4f4f9; color: #333; }
        .card { background: white; padding: 25px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h1, h2 { margin-top: 0; }
        
        /* Form Elements */
        .control-group { margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 8px; color: #555; }
        select, input[type="file"] { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; font-size: 16px; box-sizing: border-box; }
        select:focus { border-color: #007bff; outline: none; }

        /* Navigation */
        .nav-buttons { display: flex; justify-content: space-between; margin-top: 30px; gap: 10px; }
        button { padding: 12px 24px; border: none; border-radius: 6px; cursor: pointer; font-size: 16px; font-weight: 600; transition: 0.2s; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-secondary:hover { background: #545b62; }
        .btn-success { background: #28a745; color: white; width: 100%; margin-top: 0; }
        .btn-success:hover { background: #218838; }
        button:disabled { background: #ccc; cursor: not-allowed; }

        /* Preview Area */
        .question-preview { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; border-left: 5px solid #007bff; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; color: #666; font-size: 0.9em; margin-bottom: 15px; }
        
        /* Badges */
        .badge { padding: 6px 12px; border-radius: 20px; font-weight: bold; font-size: 0.8em; text-transform: uppercase; letter-spacing: 0.5px; }
        .badge-tagged { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .badge-untagged { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        /* Remaining List */
        .remaining-box { margin-top: 20px; padding: 15px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 6px; color: #856404; font-size: 0.9em; }
        .remaining-box.done { background: #d4edda; border-color: #c3e6cb; color: #155724; }
        .number-list { font-weight: bold; word-spacing: 3px; line-height: 1.5; }

        #editor-section { display: none; }
    </style>
</head>
<body>

    <div class="card">
        <h2>1. Load Data</h2>
        <p style="margin-bottom:15px; color:#666;">Upload your <code>questions.csv</code> file to start tagging.</p>
        <input type="file" id="csv-file-input" accept=".csv">
    </div>

    <div id="editor-section" class="card">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:15px; margin-bottom:20px;">
            <h2 style="margin:0;">Editor</h2>
            
            <div style="width: 200px;">
                <label for="year-select" style="font-size:0.8em; margin-bottom:4px;">Filter by Year:</label>
                <select id="year-select" onchange="filterByYear()">
                    <option value="all">All Years</option>
                </select>
            </div>
        </div>

        <div class="status-bar">
            <span id="tag-status" class="badge badge-untagged">Untagged</span>
            <span id="progress-display" style="font-weight:bold;">Question 0 of 0</span>
        </div>

        <div class="question-preview">
            <div id="q-id" style="font-weight:bold; font-size:0.85em; margin-bottom:10px; color:#666;"></div>
            <div id="q-text" style="font-size:1.1em; line-height:1.5;"></div>
        </div>

        <div id="remaining-container" class="remaining-box">
            <strong>Remaining Questions to Tag:</strong><br>
            <span id="remaining-list" class="number-list">Loading...</span>
        </div>
        <br>

        <div class="control-group">
            <label for="unit-select">Unit</label>
            <select id="unit-select" onchange="handleUnitChange()">
                <option value="">-- Select Unit --</option>
            </select>
        </div>

        <div class="control-group">
            <label for="topic-select">Topic</label>
            <select id="topic-select" onchange="handleTopicChange()">
                <option value="">-- Select Topic --</option>
            </select>
        </div>

        <div class="nav-buttons">
            <button class="btn-secondary" id="prev-btn" onclick="changeQuestion(-1)">Previous</button>
            <button class="btn-primary" id="next-btn" onclick="changeQuestion(1)">Next</button>
        </div>
    </div>

    <div class="card">
        <button class="btn-success" onclick="downloadCSV()">ðŸ’¾ Download Updated CSV</button>
    </div>

<script>
    // --- DATA CONFIGURATION ---
    const taxonomy = {
        "Our Dynamic Universe": [
            "Motion: Equations & Graphs",
            "Forces, Energy & Power",
            "Collisions, Explosions & Impulse",
            "Gravitation",
            "Special Relativity",
            "The Expanding Universe"
        ],
        "Particles and Waves": [
            "Forces on Charged Particles",
            "The Standard Model",
            "Nuclear Reactions",
            "Inverse Square Law",
            "Wave-Particle Duality",
            "Interference",
            "Spectra",
            "Refraction of Light"
        ],
        "Electricity": [
            "Monitoring and Measuring AC",
            "P,V,I,R",
            "Electrical Sources and Internal Resistance",
            "Capacitors",
            "Semiconductors and p-n Junctions"
        ],
        "Other": [
            "Skills",
            "Uncertainties"
        ]
    };

    // --- APP STATE ---
    let allQuestions = [];
    let filteredQuestions = [];
    let currentIndex = 0;

    // --- 1. FILE LOADING ---
    document.getElementById('csv-file-input').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                allQuestions = results.data;
                // Init 'tagged' column if missing
                allQuestions.forEach(q => {
                    if (q.tagged === undefined || q.tagged === "") q.tagged = "0";
                });
                initApp();
            }
        });
    });

    function initApp() {
        populateYearDropdown();
        populateUnitDropdown();
        document.getElementById('editor-section').style.display = 'block';
        filterByYear(); 
    }

    // --- 2. DROPDOWNS ---
    function populateYearDropdown() {
        const yearSet = new Set(allQuestions.map(q => q.year).filter(y => y));
        const select = document.getElementById('year-select');
        select.innerHTML = "";
        Array.from(yearSet).sort().forEach(year => {
            const opt = document.createElement('option');
            opt.value = year;
            opt.textContent = year;
            select.appendChild(opt);
        });
    }

    function populateUnitDropdown() {
        const select = document.getElementById('unit-select');
        select.innerHTML = '<option value="">-- Select Unit --</option>';
        Object.keys(taxonomy).forEach(unit => {
            const opt = document.createElement('option');
            opt.value = unit;
            opt.textContent = unit;
            select.appendChild(opt);
        });
    }

    function handleUnitChange() {
        updateTopicDropdown();
        checkImmediateTag(); // Update status immediately
    }

    function handleTopicChange() {
        checkImmediateTag(); // Update status immediately
    }

    function updateTopicDropdown(selectedTopic = null) {
        const unitSelect = document.getElementById('unit-select');
        const topicSelect = document.getElementById('topic-select');
        const currentUnit = unitSelect.value;

        topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';

        if (currentUnit && taxonomy[currentUnit]) {
            taxonomy[currentUnit].forEach(topic => {
                const opt = document.createElement('option');
                opt.value = topic;
                opt.textContent = topic;
                if (topic === selectedTopic) opt.selected = true;
                topicSelect.appendChild(opt);
            });
        }
    }

    // --- 3. LOGIC & DISPLAY ---
    function filterByYear() {
        const selectedYear = document.getElementById('year-select').value;
        filteredQuestions = allQuestions.filter(q => q.year === selectedYear);
        currentIndex = 0;
        loadQuestionUI();
    }

    function loadQuestionUI() {
        if (filteredQuestions.length === 0) {
            document.getElementById('q-text').textContent = "No questions found for this year.";
            return;
        }

        const q = filteredQuestions[currentIndex];
        const isTagged = (q.tagged === "1");

        // Display Info
        document.getElementById('q-id').textContent = `ID: ${q.id} (Year: ${q.year})`;
        document.getElementById('q-text').innerHTML = q.question_text;
        document.getElementById('progress-display').textContent = `Question ${currentIndex + 1} of ${filteredQuestions.length}`;

        // Set Dropdowns
        if (isTagged) {
            document.getElementById('unit-select').value = q.unit || "";
            updateTopicDropdown(q.topic);
        } else {
            document.getElementById('unit-select').value = "";
            updateTopicDropdown(); 
        }

        updateStatusBadge(isTagged);
        updateRemainingList();

        // Buttons
        document.getElementById('prev-btn').disabled = (currentIndex === 0);
        document.getElementById('next-btn').textContent = (currentIndex === filteredQuestions.length - 1) ? "Finish" : "Next";
    }

    function updateStatusBadge(isTagged) {
        const statusBadge = document.getElementById('tag-status');
        if (isTagged) {
            statusBadge.textContent = "TAGGED";
            statusBadge.className = "badge badge-tagged";
        } else {
            statusBadge.textContent = "UNTAGGED";
            statusBadge.className = "badge badge-untagged";
        }
    }

    function updateRemainingList() {
        const container = document.getElementById('remaining-container');
        const listSpan = document.getElementById('remaining-list');
        
        // Find indices (1-based) of untagged questions
        const untaggedIndices = [];
        filteredQuestions.forEach((q, index) => {
            if (q.tagged !== "1") untaggedIndices.push(index + 1);
        });

        if (untaggedIndices.length === 0) {
            listSpan.textContent = "All questions tagged! ðŸŽ‰";
            container.classList.add('done');
        } else {
            listSpan.textContent = untaggedIndices.join(", ");
            container.classList.remove('done');
        }
    }

    // --- 4. SAVING & UPDATING ---
    
    // Called whenever dropdowns change to update "Live" status
    function checkImmediateTag() {
        if (filteredQuestions.length === 0) return;

        const q = filteredQuestions[currentIndex];
        const unitVal = document.getElementById('unit-select').value;
        const topicVal = document.getElementById('topic-select').value;

        // If both selected, mark as tagged immediately
        if (unitVal && topicVal) {
            q.unit = unitVal;
            q.topic = topicVal;
            q.tagged = "1";
            updateStatusBadge(true);
        } else {
            // If user clears a selection, mark as untagged
            q.tagged = "0";
            updateStatusBadge(false);
        }
        
        // Update the list immediately
        updateRemainingList();
    }

    function changeQuestion(direction) {
        // Data is already saved by checkImmediateTag(), but we double check
        checkImmediateTag();
        
        const newIndex = currentIndex + direction;
        if (newIndex >= 0 && newIndex < filteredQuestions.length) {
            currentIndex = newIndex;
            loadQuestionUI();
        }
    }

    function downloadCSV() {
        const csv = Papa.unparse(allQuestions);
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.setAttribute("href", url);
        link.setAttribute("download", "questions.csv");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>