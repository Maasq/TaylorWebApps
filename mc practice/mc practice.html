<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="author" content="S Taylor" />
        <meta name="description" content="A revision aid - SQA multiple choice questions." />
        <meta name="version" content="1.06.10" /> <meta name="date" content="2026-01-04" /> 

        <title>Higher Physics Revision</title>
        <link rel="icon" type="image/webp" href="mc icon.webp">

        <script src="https://unpkg.com/dexie/dist/dexie.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
        <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

        <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

        <style>
            /* --- THEME --- */
            :root {
                --claret: #800000;
                --light-claret: #B03A2E;
                --darker-claret: #8a2e24;
                --amber: #FFBF00;
                --blush-pink: #F1D4D4;
                --pale-violet: #E6E6FA;
                --white: #FFFFFF;
                --black: #000000;
                --success-green: #28a745;
                --danger-red: #dc3545;
            }

            /* HIDE SCROLLBARS GLOBALLY */
            ::-webkit-scrollbar { display: none; }
            html, body, #view-quiz, .ms-content, #view-focus-list {
                scrollbar-width: none;
                -ms-overflow-style: none;
            }

            body {
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
                background-color: var(--pale-violet);
                margin: 0;
                padding: 20px;
                color: var(--black);
            }

            /* --- SPLASH SCREEN --- */
            #splash-overlay {
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background-color: var(--pale-violet); z-index: 9999;
                display: flex; justify-content: center; align-items: center;
                transition: opacity 0.5s ease; pointer-events: none;
            }
            .splash-icon { width: 100px; height: auto; animation: zoom-through 1.2s ease-in forwards; }
            @keyframes zoom-through {
                0% { opacity: 0; transform: scale(0.5); }
                10% { opacity: 1; transform: scale(1); }
                100% { opacity: 0; transform: scale(50); }
            }

            /* --- HEADER --- */
            .header-container {
                background-color: var(--claret);
                border-radius: 10px;
                border: 2px solid var(--black);
                box-shadow: 4px 4px 8px rgba(0, 0, 0, 0.4);
                text-align: center;
                /* Increased bottom padding to accommodate the overlap */
                padding: 20px 20px 20px 20px; 
                margin-bottom: 20px; 
                color: var(--white);
                max-width: 800px;
                margin-left: auto;
                margin-right: auto;
                position: relative;
                z-index: 5;
            }
            .header-title { color: var(--amber); font-weight: bold; font-size: 1.5em; margin: 0; }
            .header-subtitle { color: var(--blush-pink); font-size: 1.3em; margin: 0; font-weight: normal; }

            /* --- CARDS & LAYOUT --- */
            .card {
                background-color: var(--white); border-radius: 10px; border: 2px solid var(--black);
                box-shadow: 4px 4px 8px rgba(0, 0, 0, 045); padding: 20px; margin-bottom: 20px;
                max-width: 800px; margin-left: auto; margin-right: auto;
                /* Add top padding to the card content so it doesn't get hidden behind the overlap */
                padding-top: 40px; 
            }
            h3 { margin-top: 0; border-bottom: 2px solid var(--pale-violet); padding-bottom: 10px; color: var(--claret); }

            /* --- MANUAL LOADER --- */
            #manual-loader {
                display: none; background-color: var(--blush-pink); border: 2px dashed var(--claret);
                padding: 15px; margin-bottom: 20px; border-radius: 8px; text-align: center;
            }

            /* --- MULTI-SELECT --- */
            .filter-group { margin-bottom: 15px; position: relative; }
            .filter-group label { display: block; font-weight: bold; margin-bottom: 5px; }

            .ms-button {
                width: 100%; padding: 10px; border: 2px solid var(--black); border-radius: 5px; 
                font-size: 1rem; background: var(--white); font-family: inherit; text-align: left; cursor: pointer; position: relative;
                background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24"><path fill="black" d="M7 10l5 5 5-5z"/></svg>');
                background-repeat: no-repeat; background-position: right 10px center;
            }
            .ms-content {
                display: none; position: absolute; top: 100%; left: 5%; width: 90%; 
                background: var(--white); border: 2px solid var(--black); border-radius: 5px;
                max-height: 250px; overflow-y: auto; z-index: 100; margin-top: 5px;
                box-shadow: 6px 6px 12px rgba(0,0,0,0.4); 
            }
            .ms-content.show { display: block; }
            .ms-item { display: flex; align-items: center; padding: 6px 10px; border-bottom: 1px solid #eee; cursor: pointer; }
            .ms-item:hover { background-color: var(--pale-violet); }
            .ms-item input { margin-right: 10px; width: 18px; height: 18px; accent-color: var(--claret); }
            .checkbox-wrapper { display: flex; align-items: center; gap: 10px; margin: 20px 0; font-weight: bold; cursor: pointer; }
            .checkbox-wrapper input { width: 18px; height: 18px; accent-color: var(--claret); }

            /* --- BUTTONS --- */
            .nav-btn {
                background-color: var(--light-claret); color: var(--white); border: none; padding: 12px 20px;
                border-radius: 5px; font-size: 1.1em; cursor: pointer; width: 100%; font-weight: bold;
                box-shadow: 3px 3px 4px rgba(0,0,0,0.3);
            }
            .nav-btn:hover:not(:disabled) { background-color: var(--darker-claret); }
            .nav-btn:disabled { background-color: #ccc; cursor: not-allowed; box-shadow: none; opacity: 0.7; }

            .exit-btn {
                background-color: var(--amber); color: var(--claret); font-weight: bold; border: 1px solid var(--claret);
                padding: 8px 10px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; box-shadow: 3px 3px 4px rgba(0, 0, 0, 0.3);
            }
            .exit-btn:hover { background-color: #e6ac00; }

            .sketch-btn {
                background-color: var(--white); color: var(--claret); font-weight: bold; border: 1px solid var(--claret);
                padding: 8px 10px; border-radius: 5px; cursor: pointer; transition: all 0.3s ease; box-shadow: 3px 3px 4px rgba(0, 0, 0, 0.3);
            }
            .sketch-btn:hover { background-color: #e6ac00; }

            .danger-btn {
                background-color: var(--white); color: var(--danger-red); border: 2px solid var(--danger-red);
                padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px;
            }
            .danger-btn:hover { background-color: var(--danger-red); color: white; }

            /* --- QUIZ UI --- */
            .question-img { display: block; max-width: 100%; height: auto; margin: 15px auto; border-radius: 5px; }
            .option-img { max-width: 100%; max-height: auto; display: block; margin: 0 auto; }
            .options-grid { display: grid; gap: 12px; margin-top: 20px; }

            /* --- FORMATTING CSS --- */
            .center-text { text-align: center; margin: 15px 0; }
            .stmt-container { margin: 15px 0; margin-left: 40px; display: flex; flex-direction: column; gap: 7px; }
            .stmt-row { display: flex; align-items: baseline; gap: 30px; }
            .stmt-num { font-weight: bold; min-width: 25px; text-align: right; flex-shrink: 0; }
            .stmt-text { flex-grow: 1; }

            .option-btn { 
                padding: 15px; background: var(--white); border: 2px solid var(--black); border-radius: 8px; cursor: pointer; 
                font-size: 1rem; display: flex; align-items: center; width: 100%; box-sizing: border-box;
                box-shadow: 3px 3px 4px rgba(0,0,0,0.3);
            }
            .option-btn:hover { background-color: var(--pale-violet); border-color: var(--claret); }
            .option-btn.correct { background-color: #d4edda; border-color: var(--success-green); color: #155724; }
            .option-btn.wrong { background-color: var(--blush-pink); border-color: var(--claret); color: var(--claret); }

            .table-row { display: grid; gap: 0; border: 2px solid var(--black); border-radius: 8px; overflow: hidden; background: var(--white); cursor: pointer; margin-bottom: 8px; }
            .table-row:hover { background-color: var(--pale-violet); }
            .table-row.correct { background-color: #d4edda; }
            .table-row.wrong { background-color: var(--blush-pink); }
            .table-header { display: grid; background-color: white; color: black; font-weight: bold; border: 2px solid var(--black); border-bottom: none; border-radius: 8px 8px 0 0; padding: 10px 0; }
            .table-cell { padding: 10px; border-right: 1px solid #ccc; display: flex; align-items: center; justify-content: center; text-align: center; }

            .view-section { display: none; }
            .active-view { display: block; animation: fadeIn 0.4s; }
            @keyframes fadeIn { from { opacity:0; transform:translateY(10px); } to { opacity:1; transform:translateY(0); } }
            @keyframes shake { 0%, 100% { transform:translateX(0); } 25%, 75% { transform:translateX(-5px); } 50% { transform:translateX(5px); } }
            .shake { animation: shake 0.4s ease-in-out; }
            @keyframes pop { 0%, 100% { transform:scale(1); } 50% { transform:scale(1.05); } }
            .pop { animation: pop 0.4s ease-in-out; z-index: 10; }

            .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 10px; }
            .hud-container { display: flex; gap: 10px; justify-content: center; flex-grow: 1; }
            .hud-box {
                background: var(--pale-violet); color: var(--claret); padding: 8px 10px; border-radius: 5px;
                border: 1px solid var(--claret); text-align: center; font-weight: bold; font-size: 1em;
                box-shadow: 3px 3px 4px rgba(0, 0, 0, 0.3); white-space: nowrap;
            }
            #q-progress { font-size: 0.9rem; font-weight: bold; white-space: nowrap; }

            /* --- STATS & BADGES --- */
            .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 1000; }
            .modal-card { background: var(--white); width: 90%; max-width: 450px; border-radius: 10px; padding: 20px; border: 2px solid var(--black); box-shadow: 0 4px 15px rgba(0,0,0,0.5); max-height: 90vh; overflow-y: auto; }
            .stat-row { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; }
            .stat-val { font-weight: bold; color: var(--claret); }
            .badge-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-top: 15px; text-align: center; }
            .badge-item { opacity: 0.3; filter: grayscale(100%); transition: all 0.3s; }
            .badge-item.unlocked { opacity: 1; filter: grayscale(0%); transform: scale(1.1); }
            .badge-icon { font-size: 2rem; display: block; }
            .badge-name { font-size: 0.7rem; display: block; margin-top: 2px; line-height: 1.1; }

            /* Table Formatting */
            .preview-table { width: 75%; margin: 10px auto; border-collapse: collapse; font-size: 0.9em; }
            .preview-table th { background-color: white; color: black; padding: 8px; border: 1px solid black; }
            .preview-table td { padding: 8px; border: 1px solid black; text-align: center; }
            
            /* --- UNIFIED TABLE STYLES --- */
            .combined-table-container { border: 2px solid var(--black); border-radius: 8px; overflow: hidden; background-color: var(--white); margin-top: 20px; }
            .table-row-item { display: grid; border-bottom: 1px solid black; cursor: pointer; transition: background 0.1s; }
            .table-row-item:last-child { border-bottom: none; }
            .table-row-item:hover { background-color: var(--pale-violet); }
            .table-row-item.correct { background-color: #d4edda; color: #155724; } 
            .table-row-item.wrong { background-color: #f8d7da; color: #721c24; }
            .table-header-row { display: grid; border-bottom: 2px solid var(--black); background-color: var(--white); font-weight: bold; }
            .table-letter-cell { background-color: white; color: var(--claret); font-weight: bold; display: flex; align-items: center; justify-content: center; border-right: 1px solid black; }
            .table-data-cell { padding: 10px; display: flex; align-items: center; justify-content: center; text-align: center; border-right: 1px solid black; }
            .table-data-cell:last-child { border-right: none; }
            .header-content-cell { background-color: white; color: black; padding: 10px; display: flex; align-items: center; justify-content: center; text-align: center; border-right: 1px solid black; }
            .header-content-cell:last-child { border-right: none; }
            .header-empty-cell { background-color: transparent; }

            /* --- PAD & DRAWER --- */
            #notepad-drawer {
                position: fixed; bottom: -35vh; left: 0; width: 100%; height: 33vh; background-color: #fff;
                border-top: 4px solid var(--claret); box-shadow: 0 -5px 15px rgba(0,0,0,0.3); z-index: 2000;
                transition: bottom 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); display: flex; flex-direction: column;
                background-image: linear-gradient(rgba(200, 200, 200, 0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(200, 200, 200, 0.3) 1px, transparent 1px);
                background-size: 20px 20px;
            }
            #notepad-drawer.open { bottom: 0; }
            #view-quiz { position: relative; transition: height 0.3s cubic-bezier(0.25, 0.8, 0.25, 1); }
            #view-quiz.shrunk { height: 67vh; overflow-y: auto; padding-bottom: 20px; box-sizing: border-box; }
            #view-quiz.frozen { overflow-y: hidden !important; }
            #overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; pointer-events: none; touch-action: none; }
            .annotating #overlay-canvas { pointer-events: auto; background-color: rgba(0,0,0,0.02); }
            .notepad-toolbar-new { background-color: var(--white); padding: 5px; display: flex; gap: 8px; border-bottom: 1px solid #ccc; align-items: center; justify-content: flex-end; }
            .notepad-canvas-container { flex-grow: 1; position: relative; overflow: hidden; width: 100%; touch-action: none; }
            .tool-icon-btn {
                width: 32px; height: 32px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer;
                display: flex; justify-content: center; align-items: center; font-size: 1.2rem; background: white;
            }
            .tool-icon-btn:hover { background: #f0f0f0; }
            .tool-icon-btn.active { border-color: black; background: #eee; transform: scale(1.1); }
            
            /* --- UPDATED TOAST ANIMATION & STYLE --- */
            #toast-container {
                position: fixed; bottom: 40%; left: 50%; transform: translateX(-50%);
                width: 200px; background: var(--white); color: var(--black);
                border: 2px solid var(--claret); border-radius: 15px; padding: 15px;
                font-weight: bold; text-align: center; z-index: 5000; opacity: 0; pointer-events: none;
                box-shadow: 0 4px 10px rgba(0,0,0,0.3); display: flex; align-items: center; justify-content: center;
            }
            @keyframes floatUpFade {
                0% { opacity: 0; transform: translate(-50%, 0); }
                10% { opacity: 1; transform: translate(-50%, 0); }
                70% { opacity: 1; }
                100% { opacity: 0; transform: translate(-50%, -30vh); }
            }
            .toast-active { animation: floatUpFade 2.5s ease-out forwards; }

            /* --- FOCUS LIST VIEW STYLES --- */
            #view-focus-list { height: 100vh; overflow-y: auto; padding: 20px; box-sizing: border-box; }
            .focus-controls { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; flex-wrap: wrap; }
            .focus-select { padding: 8px; border: 2px solid var(--black); border-radius: 5px; flex-grow: 1; font-size: 1rem; }
            .focus-list-container { background: white; border: 2px solid var(--black); border-radius: 8px; overflow: hidden; }
            .focus-header-row { display: grid; grid-template-columns: 60px 40px 1fr 90px 50px; background: var(--claret); color: white; font-weight: bold; padding: 10px; font-size: 0.9em; gap: 5px; }
            .focus-item-row { display: grid; grid-template-columns: 60px 40px 1fr 90px 50px; border-bottom: 1px solid #ccc; padding: 12px 10px; align-items: center; cursor: pointer; font-size: 0.9em; gap: 5px; }
            .focus-item-row:hover { background-color: var(--pale-violet); }
            .focus-item-row:last-child { border-bottom: none; }
            .focus-cell { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
            .focus-bin { cursor: pointer; display: flex; justify-content: center; align-items: center; opacity: 0.7; }
            .focus-bin:hover { opacity: 1; transform: scale(1.1); }

            /* --- FAB MENU STYLES --- */
            .fab-wrapper {
                position: fixed;
                bottom: 25px;
                right: 25px;
                display: flex;
                flex-direction: column-reverse; /* Makes items stack upwards */
                align-items: center;
                gap: 15px;
                z-index: 2000; /* High z-index to sit on top of everything */
            }

            /* The Main Trigger Button (3 Dots) */
            .fab-main-btn {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background-color: rgba(128, 128, 128, 0.5); /* Translucent Grey */
                backdrop-filter: blur(4px); /* Optional: Adds a nice blur effect */
                color: white;
                border: none;
                font-size: 30px;
                line-height: 1;
                cursor: pointer;
                box-shadow: 0 4px 6px rgba(0,0,0,0.2);
                transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
                display: flex;
                justify-content: center;
                align-items: center;
                padding-bottom: 5px; /* Slight adjustment to center the dots */
            }

            /* Hover state for closed button */
            .fab-main-btn:hover {
                background-color: rgba(128, 128, 128, 0.8);
            }

            /* OPEN STATE: Turn Claret and Solid */
            .fab-wrapper.open .fab-main-btn {
                background-color: var(--claret);
                opacity: 1; /* Fully opaque */
                transform: rotate(90deg); /* Rotates the dots for effect */
                box-shadow: 0 6px 12px rgba(128, 0, 0, 0.4);
            }

            /* The Menu Items (Hidden by default) */
            .fab-items {
                display: flex;
                flex-direction: column-reverse;
                gap: 12px;
                opacity: 0;
                visibility: hidden;
                transform: translateY(20px);
                transition: all 0.3s ease;
            }

            /* Show items when wrapper has 'open' class */
            .fab-wrapper.open .fab-items {
                opacity: 1;
                visibility: visible;
                transform: translateY(0);
            }

            /* Styling for the Tool Buttons (Data, Eq, Stats) */
            .fab-action-btn {
                width: 48px;
                height: 48px;
                border-radius: 50%;
                border: 2px solid var(--claret);
                background-color: white;
                color: var(--claret);
                font-weight: bold;
                font-size: 12px;
                cursor: pointer;
                box-shadow: 0 3px 6px rgba(0,0,0,0.2);
                display: flex;
                justify-content: center;
                align-items: center;
                text-transform: uppercase;
                transition: transform 0.2s;
            }

            .fab-action-btn:hover {
                background-color: var(--pale-violet);
                transform: scale(1.1);
            }
            
            /* Special Style for Image Modals to maximize screen space */
            .image-modal-card {
                width: 95%;
                height: 90vh; /* Takes up most of the vertical screen */
                max-width: 800px;
                padding: 0; /* Remove padding so image goes edge-to-edge */
                display: flex;
                flex-direction: column;
                background: var(--white);
                overflow: hidden; /* Hide overflow on the card itself */
            }

            .modal-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 10px 15px;
                background-color: var(--white);
                border-bottom: 2px solid var(--claret);
                flex-shrink: 0; /* Keeps header fixed at top */
                z-index: 10;
            }

            .modal-header h2 {
                margin: 0;
                font-size: 1rem;
                color: var(--claret);
            }

            .modal-header button {
                background: none;
                border: none;
                font-size: 1.5rem;
                cursor: pointer;
                color: var(--black);
                padding: 0 10px;
            }

            /* The scrollable area */
            .zoom-container {
                flex-grow: 1;
                overflow: auto; /* Enables scrolling */
                -webkit-overflow-scrolling: touch; /* Momentum scrolling on iOS */
                background-color: #f0f0f0; /* Grey background helps see edges of paper */
                display: flex;
                justify-content: center; /* Centers image initially if smaller than screen */
                align-items: flex-start;
            }

            .sheet-image {
                display: block;
                max-width: 100%; /* Fits to width initially */
                height: auto;
                /* Prevent the image from being selected/dragged */
                user-select: none;
                -webkit-user-drag: none;
                transform-origin: 0 0;
            }
            
            @media (max-width: 600px) {
                .sheet-image {
                    max-width: none; /* Disable "fit to screen" */
                    width: 160%; /* Force image to be 1.8x screen width (readable size) */
                }
            }
            
        </style>
    </head>
    
    <body>
        <div id="splash-overlay">
            <img src="mc icon.webp" alt="Loading..." class="splash-icon">
        </div>
        
        <div id="toast-container"></div>

        <header class="header-container">
            <h1 class="header-title">Higher Physics Revision</h1>
            <h2 class="header-subtitle">Multiple Choice Practice</h2>
        </header>

        <div id="view-dashboard" class="view-section active-view">
            <div class="card">
                <h3>Select Practice Area</h3>

                <div id="manual-loader">
                    <strong>Local Mode / Load Failed</strong><br>
                    Please load <code>questions.csv</code> manually.<br>
                    <input type="file" id="csv-uploader" accept=".csv" style="margin-top:10px;">
                </div>

                <div class="filter-group">
                    <label>Unit</label>
                    <button class="ms-button" id="btn-unit">All Units</button>
                    <div class="ms-content" id="list-unit"></div>
                </div>

                <div class="filter-group">
                    <label>Topic</label>
                    <button class="ms-button" id="btn-topic">All Topics</button>
                    <div class="ms-content" id="list-topic"></div>
                </div>

                <div class="filter-group">
                    <label>Paper Year</label>
                    <button class="ms-button" id="btn-year">All Years</button>
                    <div class="ms-content" id="list-year"></div>
                </div>

                <label class="checkbox-wrapper">
                    <input type="checkbox" id="chk-shuffle" checked>
                    <span>Shuffle Questions</span>
                </label>

                <button class="nav-btn" onclick="startQuiz()" id="btn-start" disabled>Start Quiz</button>
                <p id="q-count-preview" style="text-align: center; color: var(--darker-claret); font-weight:bold; margin-top: 15px;">Waiting for data...</p>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button id="btn-view-focus" class="nav-btn" onclick="viewFocusList()" disabled>View Focus List</button>
                    <button id="btn-attempt-focus" class="nav-btn" onclick="attemptFocusList()" disabled>Attempt Focus List</button>
                </div>
            </div>
        </div>

        <div id="view-quiz" class="view-section">
            <canvas id="overlay-canvas"></canvas>

            <div class="card">
                <div class="top-bar" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                    
                    <button onclick="exitToDashboard()" class="exit-btn" style="margin-right: auto;" aria-label="Exit" title="Exit">
                      <img src="home.webp" style="width: 24px; height: 24px; vertical-align: middle;"> 
                    </button>
                    
                    <div class="hud-container" style="position: absolute; left: 50%; transform: translateX(-50%); display: flex; gap: 10px;">
                        <div class="hud-box" style="display: flex; align-items: center; gap: 8px;">
                            <img src="score.webp" style="width: 24px; height: 24px;">
                            <span id="hud-score">0/0</span>
                        </div>
                        <div class="hud-box" style="display: flex; align-items: center; gap: 8px;">
                            <span id="hud-streak">0</span>
                            <img src="fire.webp" style="width: 24px; height: 24px;">
                        </div>
                    </div>

                    <button onclick="toggleNotepad()" class="sketch-btn" style="margin-left: auto; pointer;" aria-label="SketchPad" title="SketchPad">
                      <img src="pad.webp" style="width: 24px; height: 24px; vertical-align: middle;"> 
                    </button>
                </div>

                <div style="margin-bottom:15px; border-bottom: 2px solid var(--pale-violet); padding-bottom:10px; display: flex; justify-content: space-between; align-items: flex-end;">
                    <span id="q-meta" style="color:var(--darker-claret); font-weight:bold; font-size:0.9em;"></span>
                    <span id="q-progress" style="font-size: 0.9rem; font-weight: bold; white-space: nowrap; color: black;"></span>
                </div>

                <div id="q-text" style="font-size:1.2em; font-weight:normal; line-height: 1.5; margin-bottom: 15px;"></div>
                <div id="q-image-area"></div>
                <div id="table-header-container"></div>
                <div id="options-area" class="options-grid"></div>
                <div id="feedback" style="margin-top:20px; font-weight:bold; height: 24px;"></div>

                <br>
                
                <div id="nav-buttons-container" style="display: flex; gap: 10px; align-items: stretch;">
                    <button id="next-btn" class="nav-btn" onclick="nextQuestion()" disabled style="flex: 8.5; width: 85%;">Next Question</button>
                    <button id="btn-focus-action" class="sketch-btn" onclick="addToFocusList()" style="flex: 1.5; width: 15%; display: flex; justify-content: center; align-items: center;">
                        <img src="focus list.webp" style="width: 24px; height: 24px;">
                    </button>
                </div>

            </div>
        </div>

        <div id="view-focus-list" class="view-section">
            <div class="card" style="max-width: 700px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin:0; color:var(--claret);">Focus List</h2>
                    <button class="exit-btn" onclick="exitToDashboard()">Close</button>
                </div>

                <div class="focus-controls">
                    <select id="focus-sort" class="focus-select" onchange="sortFocusList()">
                        <option value="date">Sort by Date Added</option>
                        <option value="year">Sort by Year</option>
                        <option value="topic">Sort by Topic</option>
                        <option value="unit">Sort by Unit</option>
                    </select>
                    
                    <button class="sketch-btn" onclick="copyFocusList()" title="Copy to Clipboard" style="display: flex; align-items: center; gap: 6px;">
                        <img src="copy.webp" style="width: 24px; height: 24px;"> Copy
                    </button>
                    
                    <button class="sketch-btn" onclick="clearFocusList()" title="Clear List" style="color:var(--danger-red); border-color:var(--danger-red); display: flex; align-items: center; gap: 6px;">
                        <img src="clear.webp" style="width: 24px; height: 24px;"> Clear
                    </button>
                </div>

                <div class="focus-list-container">
                    <div class="focus-header-row">
                        <div>Year</div>
                        <div>Q#</div>
                        <div>Topic</div>
                        <div>Added</div>
                        <div style="text-align: center;">Remove</div>
                    </div>
                    <div id="focus-list-body">
                        </div>
                </div>
            </div>
        </div>

        <div id="view-summary" class="view-section">
            <div class="card" style="text-align: center; padding: 50px;">
                <h2 style="font-size: 2rem; color: var(--claret);">Quiz Complete!</h2>
                <div style="font-size: 4rem; font-weight: bold; margin: 20px 0; color: var(--amber); text-shadow: 2px 2px 0px black;" id="final-score">0%</div>
                <p id="final-stats" style="color: var(--black); font-size: 1.2rem;"></p>
                <br>
                <button class="nav-btn" onclick="exitToDashboard()">Return to Dashboard</button>
            </div>
        </div>

        <div id="stats-modal" class="modal-overlay" onclick="closeStats(event)">
            <div class="modal-card">
                <h2 style="color:var(--claret); text-align:center; margin-top:0;">Your Achievements</h2>
                <div class="stat-row"><span>Total Correct:</span><span class="stat-val" id="stat-total">0</span></div>
                <div class="stat-row"><span>First Attempt Correct:</span><span class="stat-val" id="stat-first">0</span></div>
                <div class="stat-row"><span>Highest Streak:</span><span class="stat-val" id="stat-streak">0</span></div>
                <h4 style="margin-bottom:5px; border-bottom:1px solid #ccc; margin-top:20px;">Badges</h4>
                <div class="badge-grid" id="badge-container"></div>
                <button class="nav-btn" style="margin-top:20px;" onclick="document.getElementById('stats-modal').style.display='none'">Close</button>
                <button class="danger-btn" onclick="resetStats()">‚ö†Ô∏è Reset All Progress</button>
            </div>
        </div>

        <div id="notepad-drawer">
            <div class="notepad-toolbar-new">
                <div class="tool-icon-btn" onclick="setTool('eraser')" title="Eraser" style="margin-right:8px;">
                     <img src="eraser.webp" alt="Eraser" style="width: 24px; height: 24px; vertical-align: middle;">
                </div>
                
                <div class="tool-icon-btn color-black active" onclick="setTool('black')" style="color:black;" title="Black pen">‚úé</div>
                <div class="tool-icon-btn color-blue" onclick="setTool('blue')" style="color:blue;" title="Blue pen">‚úé</div>
                <div class="tool-icon-btn color-red" onclick="setTool('red')" style="color:red;" title="Red pen">‚úé</div>
                <div class="tool-icon-btn color-green" onclick="setTool('green')" style="color:green;" title="Green pen">‚úé</div>
                <div class="tool-icon-btn color-yellow" onclick="setTool('highlight')" style="color:#FFBF00; font-weight:bold; margin-right:8px;" title="Highlighter">
                    <img src="highlighter.webp" alt="Eraser" style="width: 24px; height: 24px; vertical-align: middle;">
                </div>

                <div class="tool-icon-btn" id="btn-annotate" onclick="toggleAnnotate()" title="Annotate Question">
                    <img src="annotate.webp" alt="Eraser" style="width: 24px; height: 24px; vertical-align: middle;">
                </div>
                <div class="tool-icon-btn" onclick="clearCanvas('current')" title="Clear SketchPad" style="margin-right:8px;">
                    <img src="clear.webp" alt="Eraser" style="width: 24px; height: 24px; vertical-align: middle;">
                </div>
                <div class="tool-icon-btn" onclick="toggleNotepad()" title="Close SketchPad">‚ñº</div>
            </div>
            <div class="notepad-canvas-container">
                <canvas id="scrap-canvas"></canvas>
            </div>
        </div>
        
        <div class="fab-wrapper" id="fab-menu">
            <button class="fab-main-btn" onclick="toggleFab()">
                &#8942; </button>

            <div class="fab-items">
                <button class="fab-action-btn" onclick="openStats()" title="Stats & Achievements">
                    <img src="trophy.webp" style="width: 48px; height: 48px; vertical-align: middle;">
                </button>
                <button class="fab-action-btn" onclick="openEquations()" title="Equation List">
                    <img src="equation.webp" style="width: 48px; height: 48px; vertical-align: middle;">
                </button>
                <button class="fab-action-btn" onclick="openData()" title="Data Sheet">
                    <img src="data.webp" style="width: 48px; height: 48px; vertical-align: middle;">
                </button>
            </div>
        </div>
        
        <div id="equation-modal" class="modal-overlay" onclick="closeModal(event, 'equation-modal')">
            <div class="modal-card image-modal-card">
                <div class="modal-header">
                    <h2>Relationships</h2>
                    <button onclick="document.getElementById('equation-modal').style.display='none'">‚úï</button>
                </div>

                <div class="zoom-container">
                    <img src="equations.webp" alt="Equation Sheet" class="sheet-image">
                </div>
            </div>
        </div>
        
        <div id="data-modal" class="modal-overlay" onclick="closeModal(event, 'data-modal')">
            <div class="modal-card image-modal-card">
                <div class="modal-header">
                    <h2>Data Sheet</h2>
                    <button onclick="document.getElementById('data-modal').style.display='none'">‚úï</button>
                </div>

                <div class="zoom-container">
                    <img src="datasheet.webp" alt="Data Sheet" class="sheet-image">
                </div>
            </div>
        </div>

        <script>
            // --- 1. CONFIGURATION ---
            const taxonomyOrder = ["Our Dynamic Universe", "Particles and Waves", "Electricity", "Other"];
            const taxonomy = {
                "Our Dynamic Universe": ["Motion: Equations & Graphs", "Forces, Energy & Power", "Collisions, Explosions & Impulse", "Gravitation", "Special Relativity", "The Expanding Universe"],
                "Particles and Waves": ["Forces on Charged Particles", "The Standard Model", "Nuclear Reactions", "Inverse Square Law", "Wave-Particle Duality", "Interference", "Spectra", "Refraction of Light"],
                "Electricity": ["Monitoring and Measuring AC", "P,V,I,R", "Electrical Sources and Internal Resistance", "Capacitors", "Semiconductors and p-n Junctions"],
                "Other": ["Skills", "Uncertainties"]
            };

            const allBadges = [
                { id: 'novice', icon: 'üë∂', name: 'Novice', desc: '1st Correct Answer', type: 'total', threshold: 1 },
                { id: 'bronze', icon: 'ü•â', name: 'Bronze', desc: '10 Total Correct', type: 'total', threshold: 10 },
                { id: 'silver', icon: 'ü•à', name: 'Silver', desc: '50 Total Correct', type: 'total', threshold: 50 },
                { id: 'gold', icon: 'ü•á', name: 'Gold', desc: '100 Total Correct', type: 'total', threshold: 100 },
                { id: 'warmup', icon: '‚è±Ô∏è', name: 'Warm Up', desc: 'Attempt 5 Questions (~10 mins)', type: 'count', threshold: 5 },
                { id: 'hour1', icon: '‚åõ', name: 'Focused', desc: 'Attempt 30 Questions (~1 hour)', type: 'count', threshold: 30 },
                { id: 'hour5', icon: 'üèãÔ∏è', name: 'Marathon', desc: 'Attempt 150 Questions (~5 hours)', type: 'count', threshold: 150 },
                { id: 'streak3', icon: 'üî•', name: 'Heating Up', desc: 'Streak of 3', type: 'streak', threshold: 3 },
                { id: 'streak10', icon: 'üöÄ', name: 'Unstoppable', desc: 'Streak of 10', type: 'streak', threshold: 10 },
                { id: 'smartypants', icon: '‚ö°', name: 'Sharp', desc: '10 Correct on 1st Try', type: 'first', threshold: 10 },
                { id: 'nightowl', icon: 'ü¶â', name: 'Night Owl', desc: 'Revise after 10pm', type: 'misc' },
                { id: 'earlybird', icon: 'üåÖ', name: 'Early Bird', desc: 'Revise before 8am', type: 'misc' },
                { id: 'jack', icon: 'üÉè', name: 'Jack of All', desc: 'Attempt one from every Unit', type: 'misc' },
                { id: 'paper1', icon: 'üìú', name: 'Paper Completed', desc: 'Finish 1 Full Year', type: 'paper', threshold: 1 },
                { id: 'paper5', icon: 'üìö', name: 'Scholar', desc: 'Finish 5 Full Years', type: 'paper', threshold: 5 }
            ];

            // --- 2. DATABASES ---
            // Main Stats DB
            const db = new Dexie("PhysicsAppDB");
            db.version(2).stores({ attempts: '++id, questionId, unit, isCorrect, isFirstAttempt, timestamp' });
            
            // New Focus List DB
            const focusDb = new Dexie("PhysicsFocusDB");
            focusDb.version(1).stores({ items: 'questionId, dateAdded' });

            let allQuestions = [], activeQuestions = [], currentIndex = 0;
            let sessionScore = 0, sessionAttempts = 0, currentStreak = 0;
            let state = { units: ["All"], topics: ["All"], years: ["All"] };
            let questionMap = {};
            let customTopicOrder = []; // Flattened list for sorting
            let isReviewMode = false; // State for button logic

            // --- 3. INIT ---
            window.onload = function() {
                setTimeout(() => {
                    const splash = document.getElementById('splash-overlay');
                    if (splash) { 
                        splash.style.opacity = '0'; 
                        setTimeout(() => splash.remove(), 500); 
                    }
                }, 1000);

                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.filter-group')) document.querySelectorAll('.ms-content').forEach(el => el.classList.remove('show'));
                });

                if(!localStorage.getItem('maxStreak')) localStorage.setItem('maxStreak', 0);

                // Flatten Taxonomy for Sorting
                taxonomyOrder.forEach(unit => {
                    if(taxonomy[unit]) {
                        customTopicOrder.push(...taxonomy[unit]);
                    }
                });

                Papa.parse("questions.csv", {
                    download: true, header: true, skipEmptyLines: true,
                    complete: (results) => {
                        if(results.data && results.data.length > 0) processData(results.data);
                        else document.getElementById('manual-loader').style.display = 'block';
                    },
                    error: () => { document.getElementById('manual-loader').style.display = 'block'; }
                });

                initDrawing(document.getElementById('overlay-canvas'));
                initDrawing(document.getElementById('scrap-canvas'));
                window.addEventListener('resize', resizeCanvases);
                
                updateFocusButtons(); // Check focus list on load
            };

            document.getElementById('csv-uploader').addEventListener('change', function(e) {
                Papa.parse(e.target.files[0], {
                    header: true, skipEmptyLines: true,
                    complete: function(results) {
                        document.getElementById('manual-loader').style.display = 'none';
                        processData(results.data);
                    }
                });
            });

            function processData(data) {
                allQuestions = data;
                data.forEach(q => { questionMap[q.id] = q; });
                initDashboard();
            }

            // --- 4. DASHBOARD & LOGIC ---
            function setupMultiSelect(type, items, stateKey) { 
                const btn = document.getElementById(`btn-${type}`);
                const list = document.getElementById(`list-${type}`);
                list.innerHTML = '';

                addCheckbox(list, "All", `All ${type.charAt(0).toUpperCase() + type.slice(1)}s`, true, (checked) => {
                    if (checked) {
                        state[stateKey] = ["All"];
                        list.querySelectorAll('input:not([value="All"])').forEach(el => el.checked = false);
                    } else { state[stateKey] = []; }
                    updateButtonText(btn, state[stateKey], type);
                    if(type === 'unit') updateTopicOptions();
                    updateCountPreview();
                });

                items.forEach(item => {
                    addCheckbox(list, item, item, false, (checked) => {
                        if (checked) {
                            state[stateKey] = state[stateKey].filter(x => x !== "All");
                            state[stateKey].push(item);
                            list.querySelector('input[value="All"]').checked = false;
                        } else {
                            state[stateKey] = state[stateKey].filter(x => x !== item);
                            if (state[stateKey].length === 0) { state[stateKey] = ["All"]; list.querySelector('input[value="All"]').checked = true; }
                        }
                        updateButtonText(btn, state[stateKey], type);
                        if(type === 'unit') updateTopicOptions();
                        updateCountPreview();
                    });
                });
                btn.onclick = (e) => {
                    document.querySelectorAll('.ms-content').forEach(el => { if(el !== list) el.classList.remove('show'); });
                    list.classList.toggle('show');
                    e.stopPropagation();
                };
            }

            function addCheckbox(container, value, labelText, isChecked, callback) {
                const div = document.createElement('div'); div.className = 'ms-item';
                div.onclick = (e) => { const cb = div.querySelector('input'); if (e.target !== cb) { cb.checked = !cb.checked; callback(cb.checked); } };
                const checkbox = document.createElement('input'); checkbox.type = 'checkbox'; checkbox.value = value; checkbox.checked = isChecked;
                checkbox.onclick = (e) => { e.stopPropagation(); callback(e.target.checked); };
                const span = document.createElement('span'); span.textContent = labelText;
                div.appendChild(checkbox); div.appendChild(span); container.appendChild(div);
            }

            function updateButtonText(btn, selected, type) {
                if (selected.includes("All")) btn.textContent = `All ${type.charAt(0).toUpperCase() + type.slice(1)}s`;
                else if (selected.length === 0) btn.textContent = "Select...";
                else if (selected.length === 1) btn.textContent = selected[0];
                else btn.textContent = `${selected.length} Selected`;
            }

            function initDashboard() {
                document.getElementById('btn-start').disabled = false;
                const units = [...taxonomyOrder]; setupMultiSelect('unit', units, 'units');
                const years = [...new Set(allQuestions.map(q => q.year).filter(y => y))].sort().reverse(); setupMultiSelect('year', years, 'years');
                updateTopicOptions(); updateCountPreview();
            }

            function updateTopicOptions() {
                let availableTopics = [];
                const isAllUnits = state.units.includes("All");
                taxonomyOrder.forEach(u => {
                    if (isAllUnits || state.units.includes(u)) { if (taxonomy[u]) availableTopics.push(...taxonomy[u]); }
                });
                if (!isAllUnits) {
                     state.units.forEach(u => {
                         if (!taxonomy[u]) { availableTopics.push(...new Set(allQuestions.filter(q => q.unit === u).map(q => q.topic))); }
                     });
                }
                availableTopics = [...new Set(availableTopics)];
                setupMultiSelect('topic', availableTopics, 'topics');
            }

            function getFilteredQuestions() {
                return allQuestions.filter(q => {
                    return (state.units.includes("All") || state.units.includes(q.unit)) &&
                           (state.topics.includes("All") || state.topics.includes(q.topic)) &&
                           (state.years.includes("All") || state.years.includes(q.year));
                });
            }

            function updateCountPreview() {
                document.getElementById('q-count-preview').textContent = `${getFilteredQuestions().length} questions available`;
            }

            function startQuiz() {
                activeQuestions = getFilteredQuestions();
                if (activeQuestions.length === 0) { alert("No questions match these filters!"); return; }
                if (document.getElementById('chk-shuffle').checked) activeQuestions.sort(() => Math.random() - 0.5);
                currentIndex = 0; sessionScore = 0; sessionAttempts = 0; currentStreak = 0;
                isReviewMode = false; // Normal mode
                switchView('view-quiz'); loadQuestion();
                resizeCanvases();
            }

            function switchView(viewId) {
                document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active-view'));
                document.getElementById(viewId).classList.add('active-view');
            }

            function exitToDashboard() { 
                switchView('view-dashboard'); 
                updateCountPreview(); 
                updateFocusButtons(); 
            }
            
            async function updateFocusButtons() {
                const count = await focusDb.items.count();
                const btnView = document.getElementById('btn-view-focus');
                const btnAttempt = document.getElementById('btn-attempt-focus');
                
                if (count > 0) {
                    btnView.disabled = false;
                    btnAttempt.disabled = false;
                } else {
                    btnView.disabled = true;
                    btnAttempt.disabled = true;
                }
            }

            // --- QUIZ & FORMATTING ---
            function formatQuestionText(raw) {
                if (!raw) return "";
                let html = raw;
                html = html.replace(/\[c\](.*?)\[\/c\]/gs, '<div class="center-text">$1</div>');
                html = html.replace(/\[s\](.*?)\[\/s\]/gs, (match, content) => {
                    const lines = content.split(/<br\s*\/?>|\n/gi).filter(line => line.trim() !== "");
                    let gridHtml = '<div class="stmt-container">';
                    lines.forEach(line => {
                        const parts = line.trim().match(/^([IVX]+)\s+(.*)/);
                        if (parts) { gridHtml += `<div class="stmt-row"><div class="stmt-num">${parts[1]}</div><div class="stmt-text">${parts[2]}</div></div>`; } 
                        else { gridHtml += `<div class="stmt-row"><div class="stmt-text">${line}</div></div>`; }
                    });
                    gridHtml += '</div>';
                    return gridHtml;
                });
                html = html.replace(/\[t\](.*?)\[\/t\]/gs, (match, content) => {
                    const lines = content.trim().split(/\r?\n|<br\s*\/?>/i).filter(l => l.trim());
                    if (lines.length === 0) return "";
                    let tableHtml = '<table class="preview-table">';
                    const headers = lines[0].split('|');
                    tableHtml += '<thead><tr>';
                    headers.forEach(h => tableHtml += `<th>${h.trim()}</th>`);
                    tableHtml += '</tr></thead><tbody>';
                    for (let i = 1; i < lines.length; i++) {
                        const cells = lines[i].split('|');
                        tableHtml += '<tr>';
                        cells.forEach(c => tableHtml += `<td>${c.trim()}</td>`);
                        tableHtml += '</tr>';
                    }
                    tableHtml += '</tbody></table>';
                    return tableHtml;
                });
                return html;
            }

            function loadQuestion() {
                if (currentIndex >= activeQuestions.length) return finishQuiz();
                clearCanvas('current'); 
                const q = activeQuestions[currentIndex];
                document.getElementById('q-progress').textContent = `${currentIndex + 1} / ${activeQuestions.length}`;
                document.getElementById('q-meta').textContent = `${q.year} ‚Ä¢ ${q.unit}`;
                document.getElementById('hud-score').textContent = `${sessionScore}/${sessionAttempts}`;
                document.getElementById('hud-streak').textContent = currentStreak;

                const qTextEl = document.getElementById('q-text');
                let processedText = formatQuestionText(q.question_text);
                if (q.question_image) {
                    const imgTag = `<img src="images/${q.question_image}" class="question-img">`;
                    processedText = processedText.includes('{{IMAGE}}') ? processedText.replace('{{IMAGE}}', imgTag) : processedText + imgTag;
                } else { document.getElementById('q-image-area').innerHTML = ''; }
                qTextEl.innerHTML = processedText;
                renderMathInElement(qTextEl);

                const optsArea = document.getElementById('options-area');
                optsArea.innerHTML = ''; optsArea.className = ''; 
                document.getElementById('feedback').textContent = '';
                document.getElementById('next-btn').disabled = true;

                // --- DYNAMIC BUTTON LOGIC ---
                const nextBtn = document.getElementById('next-btn');
                const focusBtn = document.getElementById('btn-focus-action');

                if (isReviewMode) {
                    // Single Review Mode: Show One Large "Return" Button
                    nextBtn.textContent = "Return to Focus List ‚Ü©";
                    nextBtn.onclick = viewFocusList;
                    nextBtn.disabled = false;
                    nextBtn.style.flex = "1";
                    nextBtn.style.width = "100%";
                    focusBtn.style.display = "none";
                } else {
                    // Normal Quiz Mode: Show "Next" (85%) and "Focus" (15%)
                    nextBtn.textContent = "Next Question";
                    nextBtn.onclick = nextQuestion;
                    nextBtn.disabled = true; 
                    nextBtn.style.flex = "8.5";
                    nextBtn.style.width = "85%";
                    
                    focusBtn.style.display = "flex";
                    focusBtn.style.flex = "1.5";
                    focusBtn.style.width = "15%";
                    focusBtn.innerHTML = '<img src="focus list.webp" style="width: 24px; height: 24px;">';
                    focusBtn.onclick = addToFocusList;
                }

                if (q.table_headers) {
                    const headers = q.table_headers.split('|');
                    const container = document.createElement('div'); container.className = 'combined-table-container';
                    const headerRow = document.createElement('div'); headerRow.className = 'table-header-row';
                    headerRow.style.gridTemplateColumns = `50px repeat(${headers.length}, 1fr)`;
                    const emptyCell = document.createElement('div'); emptyCell.className = 'header-empty-cell'; headerRow.appendChild(emptyCell);
                    headers.forEach(h => { const c = document.createElement('div'); c.className = 'header-content-cell'; c.textContent = h.trim(); headerRow.appendChild(c); });
                    container.appendChild(headerRow);
                    ['option_a', 'option_b', 'option_c', 'option_d', 'option_e'].forEach((optKey, idx) => {
                        const val = q[optKey]; if (!val) return;
                        const row = document.createElement('div'); row.className = 'table-row-item';
                        row.style.gridTemplateColumns = `50px repeat(${headers.length}, 1fr)`;
                        const letCell = document.createElement('div'); letCell.className = 'table-letter-cell'; letCell.textContent = String.fromCharCode(65 + idx); row.appendChild(letCell);
                        val.split('|').forEach(c => { const d = document.createElement('div'); d.className = 'table-data-cell'; d.textContent = c.trim(); row.appendChild(d); });
                        renderMathInElement(row);
                        row.onclick = () => checkAnswer(q, optKey, row, true);
                        container.appendChild(row);
                    });
                    optsArea.appendChild(container);
                } else {
                    optsArea.className = 'options-grid';
                    ['option_a', 'option_b', 'option_c', 'option_d', 'option_e'].forEach((optKey, idx) => {
                        const val = q[optKey]; if (!val) return;
                        const btn = document.createElement('div'); btn.className = 'option-btn';
                        btn.innerHTML = val.startsWith('[IMG]') 
                            ? `<span style="font-weight:bold; margin-right:15px; color:var(--claret);">${String.fromCharCode(65 + idx)}</span><img src="images/${val.replace('[IMG]', '')}" class="option-img">`
                            : `<span style="font-weight:bold; margin-right:15px; color:var(--claret);">${String.fromCharCode(65 + idx)}</span><span>${val}</span>`;
                        renderMathInElement(btn);
                        btn.onclick = () => checkAnswer(q, optKey, btn, false);
                        optsArea.appendChild(btn);
                    });
                }
            }

            async function checkAnswer(q, selectedKey, btn, isTable) {
                if (navigator.vibrate) navigator.vibrate(10);
                const selector = isTable ? '.table-row-item' : '.option-btn';
                document.querySelectorAll(selector).forEach(b => b.style.pointerEvents = 'none');

                const correctKey = "option_" + q.correct_answer.toLowerCase();
                const isCorrect = (selectedKey === correctKey);

                sessionAttempts++;
                if (isCorrect) { 
                    sessionScore++; currentStreak++; btn.classList.add('correct', 'pop'); 
                    document.getElementById('feedback').textContent = "Correct!"; document.getElementById('feedback').style.color = "var(--success-green)"; 
                } else { 
                    currentStreak = 0; btn.classList.add('wrong', 'shake'); 
                    document.getElementById('feedback').textContent = "Incorrect"; document.getElementById('feedback').style.color = "var(--claret)";
                    const keys = ['option_a', 'option_b', 'option_c', 'option_d', 'option_e'];
                    const idx = keys.indexOf(correctKey);
                    const all = document.querySelectorAll(selector);
                    if(idx !== -1 && all[idx]) all[idx].classList.add('correct');
                }
                document.getElementById('hud-score').textContent = `${sessionScore}/${sessionAttempts}`;
                document.getElementById('hud-streak').textContent = currentStreak;

                const attempts = await db.attempts.where('questionId').equals(q.id).toArray();
                await db.attempts.add({ questionId: q.id, unit: q.unit, isCorrect: isCorrect, isFirstAttempt: attempts.length===0, timestamp: new Date() });
                
                checkAchievements(); 
                
                // In Review Mode, the button is already enabled and acts as Return. 
                // In Normal Mode, we enable the Next button.
                if (!isReviewMode) {
                    document.getElementById('next-btn').disabled = false;
                }
            }

            function nextQuestion() { currentIndex++; loadQuestion(); }
            function finishQuiz() {
                switchView('view-summary');
                const pc = activeQuestions.length > 0 ? Math.round((sessionScore / activeQuestions.length) * 100) : 0;
                document.getElementById('final-score').textContent = `${pc}%`;
                document.getElementById('final-stats').textContent = `Session Score: ${sessionScore} / ${activeQuestions.length}`;
                if(pc === 100 && activeQuestions.length >= 5) confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
            }

            async function resetStats() {
                if(!confirm("Are you sure? This will delete all your history and badges.")) return;
                await db.attempts.clear(); localStorage.clear(); location.reload();
            }

            // --- FOCUS LIST LOGIC ---
            async function addToFocusList() {
                if (!activeQuestions[currentIndex]) return;
                const q = activeQuestions[currentIndex];
                
                // 1. Check if already exists
                const existing = await focusDb.items.get(q.id);
                
                if (existing) {
                    showToast("Already in Focus List");
                } else {
                    // 2. Add if new
                    await focusDb.items.put({ questionId: q.id, dateAdded: new Date() });
                    
                    // Extract Number logic (CSV 'number' OR split from ID)
                    let qNum = q.number;
                    if (!qNum && q.id && q.id.includes('-')) {
                        // Assumes format like "2018-05" -> "05"
                        qNum = q.id.split('-')[1];
                    }
                    if(!qNum) qNum = '?';

                    showToast(`Question ${qNum} from ${q.year} added to Focus List`);
                    updateFocusButtons();
                    
                    // 3. Skip to next question
                    setTimeout(() => {
                        nextQuestion();
                    }, 700); // 700ms Delay to let user see toast/star
                }
            }

            function showToast(message) {
                const toast = document.getElementById('toast-container');
                toast.textContent = message;
                
                // Reset Animation
                toast.classList.remove('toast-active');
                void toast.offsetWidth; // Trigger Reflow
                
                // Start Animation
                toast.classList.add('toast-active');
            }

            // --- NEW: FOCUS LIST VIEW IMPLEMENTATION ---
            let currentFocusItems = []; // To store fetched list for sorting

            async function viewFocusList() {
                // Fetch Data
                const items = await focusDb.items.toArray();
                
                // Join with Question Data
                currentFocusItems = items.map(item => {
                    const qDetails = questionMap[item.questionId];
                    if (!qDetails) return item; // Fallback

                    // Ensure number exists for sorting/display
                    let qNum = qDetails.number;
                    if (!qNum && qDetails.id && qDetails.id.includes('-')) {
                        qNum = qDetails.id.split('-')[1];
                    }

                    return { ...item, ...qDetails, extractedNum: qNum }; 
                });

                // Initial Sort (Date Added Ascending - Oldest First)
                currentFocusItems.sort((a, b) => a.dateAdded - b.dateAdded);
                document.getElementById('focus-sort').value = 'date';

                renderFocusList();
                switchView('view-focus-list');
            }

            function renderFocusList() {
                const container = document.getElementById('focus-list-body');
                container.innerHTML = '';

                if (currentFocusItems.length === 0) {
                    container.innerHTML = '<div style="padding:20px; text-align:center;">List is empty.</div>';
                    return;
                }

                currentFocusItems.forEach(item => {
                    const dateStr = item.dateAdded.toLocaleDateString('en-GB');
                    const div = document.createElement('div');
                    div.className = 'focus-item-row';
                    
                    div.innerHTML = `
                        <div class="focus-cell">${item.year}</div>
                        <div class="focus-cell">${item.extractedNum || item.number || '-'}</div>
                        <div class="focus-cell">${item.topic}</div>
                        <div class="focus-cell" style="font-size:0.8em; color:#666;">${dateStr}</div>
                        <div class="focus-bin" onclick="deleteFocusItem(event, '${item.questionId}')">
                            <img src="clear.webp" style="width:20px; height:20px;">
                        </div>
                    `;
                    
                    // Click row to jump to question
                    div.onclick = (e) => {
                        if(e.target.closest('.focus-bin')) return; // Ignore bin click
                        startFocusSingle(item.questionId);
                    };

                    container.appendChild(div);
                });
            }

            function sortFocusList() {
                const criteria = document.getElementById('focus-sort').value;
                currentFocusItems.sort((a, b) => {
                    if (criteria === 'date') {
                        // Date Added (Oldest first)
                        return a.dateAdded - b.dateAdded;
                    } 
                    if (criteria === 'year') {
                        // Year (Oldest) -> Question Number
                        if (a.year !== b.year) return a.year - b.year;
                        return (parseInt(a.extractedNum)||0) - (parseInt(b.extractedNum)||0);
                    }
                    if (criteria === 'topic') {
                        // Topic (Syllabus) -> Year -> Question Number
                        if (a.topic !== b.topic) {
                            const idxA = customTopicOrder.indexOf(a.topic);
                            const idxB = customTopicOrder.indexOf(b.topic);
                            return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                        }
                        if (a.year !== b.year) return a.year - b.year;
                        return (parseInt(a.extractedNum)||0) - (parseInt(b.extractedNum)||0);
                    }
                    if (criteria === 'unit') {
                        // Unit (Syllabus) -> Topic -> Year -> Question Number
                        if (a.unit !== b.unit) {
                            const idxA = taxonomyOrder.indexOf(a.unit);
                            const idxB = taxonomyOrder.indexOf(b.unit);
                            return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                        }
                        if (a.topic !== b.topic) {
                            const idxA = customTopicOrder.indexOf(a.topic);
                            const idxB = customTopicOrder.indexOf(b.topic);
                            return (idxA === -1 ? 999 : idxA) - (idxB === -1 ? 999 : idxB);
                        }
                        if (a.year !== b.year) return a.year - b.year;
                        return (parseInt(a.extractedNum)||0) - (parseInt(b.extractedNum)||0);
                    }
                    return 0;
                });
                renderFocusList();
            }

            async function deleteFocusItem(e, id) {
                e.stopPropagation();
                // NO CONFIRMATION (Silent Delete)
                await focusDb.items.delete(id);
                // Remove from local array and re-render
                currentFocusItems = currentFocusItems.filter(i => i.questionId !== id);
                renderFocusList();
                updateFocusButtons(); // Update dashboard state if cleared
            }

            async function clearFocusList() {
                if(!confirm("Delete ALL items in Focus List?")) return;
                await focusDb.items.clear();
                currentFocusItems = [];
                renderFocusList();
                updateFocusButtons();
            }

            function copyFocusList() {
                if(currentFocusItems.length === 0) return alert("List is empty");
                
                let text = "My Physics Focus List:\n\n";
                currentFocusItems.forEach(i => {
                    text += `‚Ä¢ ${i.year} Q${i.extractedNum || i.number || '?'} (${i.topic}) - Added ${i.dateAdded.toLocaleDateString()}\n`;
                });
                
                navigator.clipboard.writeText(text).then(() => {
                    showToast("Copied to clipboard");
                });
            }

            async function attemptFocusList() {
                // 1. Fetch items
                const items = await focusDb.items.toArray();
                if (items.length === 0) return; // Should be disabled anyway

                // 2. Map IDs to full question objects
                activeQuestions = items.map(i => questionMap[i.questionId]).filter(q => q);

                if (activeQuestions.length === 0) return alert("Error loading questions. Check data source.");

                // 3. Shuffle if requested
                if (document.getElementById('chk-shuffle').checked) {
                    activeQuestions.sort(() => Math.random() - 0.5);
                } 

                // 4. Reset Quiz State
                currentIndex = 0;
                sessionScore = 0;
                sessionAttempts = 0;
                currentStreak = 0;
                isReviewMode = false; // We treat this as a normal quiz attempt

                // 5. Start
                switchView('view-quiz');
                loadQuestion();
                resizeCanvases();
            }

            function startFocusSingle(id) {
                // Creates a 1-question quiz session
                const q = questionMap[id];
                if(!q) return alert("Question data error");
                
                activeQuestions = [q];
                currentIndex = 0;
                sessionScore = 0;
                sessionAttempts = 0;
                isReviewMode = true; // Sets context for Back button
                
                switchView('view-quiz');
                loadQuestion();
            }

            // --- DRAWING & BADGES ---
            async function openStats() {
                document.getElementById('stats-modal').style.display = 'flex';
                const allAttempts = await db.attempts.toArray();
                const totalCorrect = allAttempts.filter(a => a.isCorrect).length;
                const firstCorrect = allAttempts.filter(a => a.isFirstAttempt && a.isCorrect).length;
                const maxStreak = parseInt(localStorage.getItem('maxStreak') || 0);
                const currentBest = Math.max(currentStreak, maxStreak);

                document.getElementById('stat-total').textContent = totalCorrect;
                document.getElementById('stat-first').textContent = firstCorrect;
                document.getElementById('stat-streak').textContent = currentBest;
                renderBadges(allAttempts, totalCorrect, firstCorrect, currentBest);
            }
            function closeStats(e) { if(e.target.id === 'stats-modal') document.getElementById('stats-modal').style.display = 'none'; }
            async function checkAchievements() {
                const savedMax = parseInt(localStorage.getItem('maxStreak') || 0);
                if (currentStreak > savedMax) localStorage.setItem('maxStreak', currentStreak);
                const allAttempts = await db.attempts.toArray();
                const totalCorrect = allAttempts.filter(a => a.isCorrect).length;
                const firstCorrect = allAttempts.filter(a => a.isFirstAttempt && a.isCorrect).length;
                const totalAttempts = allAttempts.length;
                const streak = Math.max(currentStreak, savedMax);
                const attemptedQIDs = [...new Set(allAttempts.map(a => a.questionId))];
                const unitsHit = new Set();
                const qByYear = {};
                attemptedQIDs.forEach(qid => { const q = questionMap[qid]; if(q) { unitsHit.add(q.unit); if(!qByYear[q.year]) qByYear[q.year] = 0; qByYear[q.year]++; } });
                let papersDone = 0;
                const allYears = [...new Set(allQuestions.map(q => q.year))];
                allYears.forEach(y => { const totalForYear = allQuestions.filter(q => q.year === y).length; if (qByYear[y] && qByYear[y] >= totalForYear) papersDone++; });
                const now = new Date(); const hour = now.getHours();
                allBadges.forEach(b => {
                    const key = 'badge_unlocked_' + b.id;
                    if (localStorage.getItem(key)) return; 
                    let unlocked = false;
                    if (b.type === 'total' && totalCorrect >= b.threshold) unlocked = true;
                    if (b.type === 'first' && firstCorrect >= b.threshold) unlocked = true;
                    if (b.type === 'streak' && streak >= b.threshold) unlocked = true;
                    if (b.type === 'count' && totalAttempts >= b.threshold) unlocked = true;
                    if (b.type === 'paper' && papersDone >= b.threshold) unlocked = true;
                    if (b.id === 'nightowl' && (hour >= 22 || hour < 4)) unlocked = true;
                    if (b.id === 'earlybird' && (hour >= 5 && hour < 8)) unlocked = true;
                    if (b.id === 'jack' && unitsHit.size >= 4) unlocked = true; 
                    if (unlocked) { localStorage.setItem(key, 'true'); confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
                });
            }
            function renderBadges(allAttempts, total, first, streak) {
                const container = document.getElementById('badge-container'); container.innerHTML = '';
                allBadges.forEach(b => {
                    const isUnlocked = localStorage.getItem('badge_unlocked_' + b.id);
                    const div = document.createElement('div');
                    div.className = `badge-item ${isUnlocked ? 'unlocked' : ''}`;
                    div.innerHTML = `<span class=\"badge-icon\">${b.icon}</span><span class=\"badge-name\">${b.name}</span>`;
                    div.title = b.desc;
                    container.appendChild(div);
                });
            }

            let isPadOpen = false; let isAnnotating = false;
            let drawState = { color: 'black', width: 2, alpha: 1.0, composite: 'source-over' };
            let isDrawing = false; let lastX = 0, lastY = 0; let activeCanvas = null;

            function toggleNotepad() {
                const drawer = document.getElementById('notepad-drawer');
                const quizView = document.getElementById('view-quiz');
                if (isPadOpen) { drawer.classList.remove('open'); quizView.classList.remove('shrunk'); if(isAnnotating) toggleAnnotate(); isPadOpen = false; } 
                else { drawer.classList.add('open'); quizView.classList.add('shrunk'); isPadOpen = true; }
            }
            function toggleAnnotate() {
                const btn = document.getElementById('btn-annotate');
                const quizView = document.getElementById('view-quiz');
                isAnnotating = !isAnnotating;
                if (isAnnotating) { btn.classList.add('active'); quizView.classList.add('frozen', 'annotating'); } 
                else { btn.classList.remove('active'); quizView.classList.remove('frozen', 'annotating'); }
            }
            function setTool(tool) {
                document.querySelectorAll('.tool-icon-btn').forEach(b => b.classList.remove('active'));
                if(tool === 'annotate' || tool === 'clear' || tool === 'close') return;
                const clicked = [...document.querySelectorAll('.tool-icon-btn')].find(b => b.onclick.toString().includes(`'${tool}'`));
                if(clicked) clicked.classList.add('active');
                if (tool === 'eraser') { drawState.composite = 'destination-out'; drawState.width = 30; drawState.alpha = 1.0; } 
                else if (tool === 'highlight') { drawState.composite = 'source-over'; drawState.color = 'yellow'; drawState.width = 40; drawState.alpha = 0.05; } 
                else { drawState.composite = 'source-over'; drawState.color = tool; drawState.width = 2; drawState.alpha = 1.0; }
            }
            function clearCanvas(target) {
                if (target === 'current') {
                    const overlay = document.getElementById('overlay-canvas'); const scrap = document.getElementById('scrap-canvas');
                    overlay.getContext('2d').clearRect(0,0,overlay.width, overlay.height); scrap.getContext('2d').clearRect(0,0,scrap.width, scrap.height);
                } else if (target === 'overlay') { const overlay = document.getElementById('overlay-canvas'); overlay.getContext('2d').clearRect(0,0,overlay.width, overlay.height); }
            }
            function initDrawing(canvas) { const events = ['mousedown', 'mousemove', 'mouseup', 'mouseout', 'touchstart', 'touchmove', 'touchend']; events.forEach(ev => canvas.addEventListener(ev, handleDrawEvent, { passive: false })); }
            function resizeCanvases() {
                const overlay = document.getElementById('overlay-canvas'); const quizView = document.getElementById('view-quiz');
                overlay.width = quizView.clientWidth; overlay.height = quizView.clientHeight;
                const scrap = document.getElementById('scrap-canvas'); const scrapContainer = document.querySelector('.notepad-canvas-container');
                if(scrapContainer) { scrap.width = scrapContainer.clientWidth; scrap.height = scrapContainer.clientHeight; }
            }
            function getCoords(e, canvas) {
                const rect = canvas.getBoundingClientRect(); let clientX, clientY;
                if(e.touches && e.touches.length > 0) { clientX = e.touches[0].clientX; clientY = e.touches[0].clientY; } 
                else { clientX = e.clientX; clientY = e.clientY; }
                return { x: clientX - rect.left, y: clientY - rect.top };
            }
            function handleDrawEvent(e) {
                const canvas = e.target;
                if (canvas.id === 'overlay-canvas' && !isAnnotating) return;
                const ctx = canvas.getContext('2d'); const coords = getCoords(e, canvas);
                if (e.type === 'mousedown' || e.type === 'touchstart') {
                    e.preventDefault(); isDrawing = true; activeCanvas = canvas; lastX = coords.x; lastY = coords.y;
                    ctx.beginPath(); ctx.fillStyle = drawState.composite === 'destination-out' ? 'rgba(0,0,0,1)' : drawState.color;
                    ctx.globalAlpha = drawState.alpha; ctx.globalCompositeOperation = drawState.composite;
                    ctx.arc(lastX, lastY, drawState.width/2, 0, Math.PI*2); ctx.fill();
                } else if (e.type === 'mousemove' || e.type === 'touchmove') {
                    if (!isDrawing || activeCanvas !== canvas) return; e.preventDefault();
                    ctx.beginPath(); ctx.moveTo(lastX, lastY); ctx.lineTo(coords.x, coords.y);
                    ctx.strokeStyle = drawState.color; ctx.lineWidth = drawState.width; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
                    ctx.globalAlpha = drawState.alpha; ctx.globalCompositeOperation = drawState.composite;
                    ctx.stroke(); lastX = coords.x; lastY = coords.y;
                } else if (e.type === 'mouseup' || e.type === 'mouseout' || e.type === 'touchend') { isDrawing = false; activeCanvas = null; }
            }
            
            // --- FAB MENU LOGIC ---
            function toggleFab() {
                document.getElementById('fab-menu').classList.toggle('open');
            }

            // Optional: Close menu if clicking anywhere else on the screen
            document.addEventListener('click', function(event) {
                const fab = document.getElementById('fab-menu');
                const isClickInside = fab.contains(event.target);

                // If the menu is open and the click was OUTSIDE the menu, close it
                if (fab.classList.contains('open') && !isClickInside) {
                    fab.classList.remove('open');
                }
            });
            
            function openData() {
                document.getElementById('data-modal').style.display = 'flex';
                document.getElementById('fab-menu').classList.remove('open');
            }
            
            function openEquations() {
                document.getElementById('equation-modal').style.display = 'flex';
                document.getElementById('fab-menu').classList.remove('open');
            }

            function closeModal(event, modalId) {
                if (event.target.id === modalId) {
                    document.getElementById(modalId).style.display = 'none';
                }
            }
            
            document.addEventListener("DOMContentLoaded", function() {
                renderMathInElement(document.body, {
                    delimiters: [
                        {left: "$$", right: "$$", display: true},
                        {left: "$", right: "$", display: false}
                    ]
                });
            });
        </script>
    </body>
</html>