<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Config Builder</title>
    <style>
        :root { --primary: #2c3e50; --accent: #3498db; --bg: #f4f6f8; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: #333; }
        .container { max-width: 1000px; margin: 0 auto; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        
        /* CARDS */
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        h2 { margin-top: 0; color: var(--primary); border-bottom: 2px solid #eee; padding-bottom: 10px; font-size: 1.2rem; }
        
        /* INPUTS */
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        input[type="text"], textarea { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        textarea { height: 300px; resize: vertical; line-height: 1.5; }
        
        /* COLOUR PICKERS */
        .color-row { display: flex; gap: 20px; margin-bottom: 15px; }
        .color-group { flex: 1; }
        input[type="color"] { width: 100%; height: 40px; border: none; cursor: pointer; padding: 0; background: none; }
        
        /* BUTTONS */
        .btn-row { display: flex; gap: 10px; margin-top: 10px; }
        button { padding: 10px 20px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-save { background: #27ae60; color: white; flex: 2; }
        .btn-save:hover { background: #219150; }
        .btn-load { background: var(--primary); color: white; flex: 1; }
        .btn-load:hover { background: #1a252f; }
        
        /* PREVIEW */
        pre { background: #222; color: #a6e22e; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 0.85rem; height: 500px; margin: 0; }
        
        .helper-text { font-size: 0.8rem; color: #777; margin-top: -10px; margin-bottom: 10px; }
        
        /* FILE INPUT HIDDEN */
        #file-input { display: none; }
    </style>
</head>
<body>

<div class="container">
    <div class="left-col">
        
        <div class="card">
            <h2>1. App Identity</h2>
            <div style="display:flex; gap:10px;">
                <div style="flex:1;">
                    <label>Level</label>
                    <input type="text" id="inp-level" placeholder="e.g. Higher" oninput="updateConfig()">
                </div>
                <div style="flex:1;">
                    <label>Subject</label>
                    <input type="text" id="inp-subject" placeholder="e.g. Physics" oninput="updateConfig()">
                </div>
            </div>
            <label>Version</label>
            <input type="text" id="inp-version" value="1.0.0" oninput="updateConfig()">
        </div>

        <div class="card" style="margin-top:20px;">
            <h2>2. Theme Colours</h2>
            <div class="color-row">
                <div class="color-group">
                    <label>Primary (Brand)</label>
                    <input type="color" id="inp-col-primary" value="#800000" oninput="updateConfig()">
                </div>
                <div class="color-group">
                    <label>Accent (Highlight)</label>
                    <input type="color" id="inp-col-accent" value="#FFBF00" oninput="updateConfig()">
                </div>
            </div>
        </div>

        <div class="card" style="margin-top:20px;">
            <h2>3. Units & Topics</h2>
            <p class="helper-text">Paste your structure below.<br><strong>Units:</strong> Start line with text.<br><strong>Topics:</strong> Start line with a dash ( - ) or bullet.</p>
            <textarea id="inp-taxonomy" oninput="updateConfig()" placeholder="Unit 1: Dynamics&#10;- Vectors&#10;- Forces&#10;&#10;Unit 2: Space&#10;- Special Relativity"></textarea>
        </div>
    </div>

    <div class="right-col">
        <div class="card" style="height: 100%; box-sizing:border-box; display:flex; flex-direction:column;">
            <h2>Preview: config.js</h2>
            <pre id="output-code">// Config will appear here...</pre>
            
            <div class="btn-row">
                <button class="btn-load" onclick="document.getElementById('file-input').click()">ðŸ“‚ Load JS</button>
                <button class="btn-save" onclick="downloadConfig()">ðŸ’¾ Save Config.js</button>
            </div>
            <input type="file" id="file-input" accept=".js" onchange="loadConfigFile(this)">
        </div>
    </div>
</div>

<script>
    // --- UTILS ---
    function toTitleCase(str) {
        return str.replace(/\w\S*/g, (txt) => txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase());
    }

    // --- MAIN GENERATOR ---
    function updateConfig() {
        // 1. Get Values
        const levelRaw = document.getElementById('inp-level').value || "Level";
        const subjectRaw = document.getElementById('inp-subject').value || "Subject";
        const version = document.getElementById('inp-version').value;
        const colPrimary = document.getElementById('inp-col-primary').value;
        const colAccent = document.getElementById('inp-col-accent').value;
        
        const level = toTitleCase(levelRaw);
        const subject = toTitleCase(subjectRaw);
        
        // 2. Parse Taxonomy
        const taxText = document.getElementById('inp-taxonomy').value;
        const lines = taxText.split('\n');
        
        let taxonomy = {};
        let currentUnit = null;
        let unitOrder = [];

        lines.forEach(line => {
            const clean = line.trim();
            if(!clean) return;

            // Check if Topic (starts with - or * or â€¢)
            if (clean.startsWith('-') || clean.startsWith('*') || clean.startsWith('â€¢')) {
                if (currentUnit) {
                    // Remove the bullet and trim
                    const topic = clean.replace(/^[-*â€¢]\s*/, '').trim();
                    taxonomy[currentUnit].push(topic);
                }
            } else {
                // It is a Unit
                currentUnit = clean;
                if (!taxonomy[currentUnit]) {
                    taxonomy[currentUnit] = [];
                    unitOrder.push(currentUnit);
                }
            }
        });

        // 3. Build JS String
        // UPDATED: Now generates the 'Safe DB Logic' block instead of a static string
        
        const configJS = `/* --- 1. SETTINGS (Edit these for new subjects) --- */
const SUBJECT = "${subject}";
const LEVEL   = "${level}";
const VERSION = "${version}";

/* --- 2. CALCULATIONS (Do not edit below) --- */

// A. Calculate Header
const HEADER_TEXT = \`\${LEVEL} \${SUBJECT}\`;

// B. Calculate Database Names
// Logic: If it's the original "Higher Physics" app, keep the old DB names to preserve user data.
// For any other subject, auto-generate a unique name (e.g. "ChemistryN5AppDB").
let dbName, focusDbName;

if (SUBJECT === "Physics" && LEVEL === "Higher") {
    dbName = "PhysicsAppDB";
    focusDbName = "PhysicsFocusDB";
} else {
    // Remove spaces from subject/level for clean DB names
    const cleanSubject = SUBJECT.replace(/\\s+/g, '');
    const cleanLevel = LEVEL.replace(/\\s+/g, '');
    
    dbName = \`\${cleanSubject}\${cleanLevel}AppDB\`;
    focusDbName = \`\${cleanSubject}\${cleanLevel}FocusDB\`;
}

/* --- 3. EXPORT CONFIGURATION --- */
const APP_CONFIG = {
    // Identity
    subject: SUBJECT,
    level: LEVEL,
    header: HEADER_TEXT, 
    subtitle: "Multiple Choice Practice",
    version: VERSION,
    
    // Colours
    colors: {
        primary: "${colPrimary}",
        accent: "${colAccent}"
    },

    // Databases (Calculated above)
    dbName: dbName,
    focusDbName: focusDbName,
    
    // Taxonomy
    taxonomyOrder: ${JSON.stringify(unitOrder, null, 4)},
    
    taxonomy: ${JSON.stringify(taxonomy, null, 4)}
};`;

        document.getElementById('output-code').textContent = configJS;
    }

    // --- FILE OPERATIONS ---
    function downloadConfig() {
        const content = document.getElementById('output-code').textContent;
        const blob = new Blob([content], { type: "text/javascript" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "config.js";
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function loadConfigFile(input) {
        const file = input.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(e) {
            const content = e.target.result;
            
            try {
                // Extract Subject
                const subjMatch = content.match(/const SUBJECT = "([^"]+)";/);
                if(subjMatch) document.getElementById('inp-subject').value = subjMatch[1];

                // Extract Level
                const levelMatch = content.match(/const LEVEL   = "([^"]+)";/);
                if(levelMatch) document.getElementById('inp-level').value = levelMatch[1];
                
                // Extract Version
                const verMatch = content.match(/const VERSION = "([^"]+)";/);
                if(verMatch) document.getElementById('inp-version').value = verMatch[1];

                // Extract Colors
                const colPMatch = content.match(/primary:\s*"([^"]+)"/);
                if(colPMatch) document.getElementById('inp-col-primary').value = colPMatch[1];

                const colAMatch = content.match(/accent:\s*"([^"]+)"/);
                if(colAMatch) document.getElementById('inp-col-accent').value = colAMatch[1];

                // Extract Taxonomy
                const taxBlockMatch = content.match(/taxonomy:\s*({[\s\S]*?})\s*};/);
                if (taxBlockMatch) {
                    const taxObj = eval("(" + taxBlockMatch[1] + ")");
                    let text = "";
                    for (const unit in taxObj) {
                        text += unit + "\n";
                        taxObj[unit].forEach(topic => {
                            text += "- " + topic + "\n";
                        });
                        text += "\n";
                    }
                    document.getElementById('inp-taxonomy').value = text.trim();
                }

                updateConfig(); 
                
            } catch (err) {
                alert("Could not parse file. Make sure it is a valid config.js");
                console.error(err);
            }
        };
        reader.readAsText(file);
    }

    // Init
    updateConfig();
</script>

</body>
</html>