<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Question Tagger (Side-by-Side)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>

    <script src="config.js"></script>

    <style>
        /* --- SHARED THEME --- */
        :root {
            --claret: #800000;
            --light-claret: #B03A2E;
            --amber: #FFBF00;
            --white: #FFFFFF;
            --black: #000000;
            --success-green: #28a745;
            --bg-gray: #f0f2f5;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-gray);
            margin: 0;
            padding: 20px;
            color: #333;
        }

        /* --- LAYOUT CONFIG --- */
        .container { 
            max-width: 1350px; 
            margin: 0 auto; 
        }

        /* The Main Grid Split */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 50% - 50% split */
            gap: 25px;
            align-items: start;
        }

        .card {
            background-color: var(--white);
            border-radius: 8px;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
            padding: 20px;
            margin-bottom: 20px;
        }

        /* --- LEFT COLUMN: CONTROLS & EDITOR --- */
        
        .control-group { margin-bottom: 15px; }

        .nav-grid {
            display: grid;
            grid-template-columns: 1fr 2fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .nav-btn {
            background-color: var(--light-claret); color: var(--white); border: none; padding: 10px;
            border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%;
        }
        .nav-btn:hover { background-color: var(--claret); }

        .save-btn {
            background-color: var(--success-green); color: white; border: none; padding: 10px;
            border-radius: 6px; font-weight: bold; cursor: pointer; width: 100%;
        }

        /* UPDATED: Added space for the Number Input */
        .dropdown-grid {
            display: grid;
            grid-template-columns: 5fr 5fr 1fr;
            gap: 10px;
        }

        select, input[type="text"] {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px;
            font-size: 0.95rem; background: var(--white); color: #333; box-sizing: border-box;
        }
        select:focus, input:focus { border-color: var(--claret); outline: none; }

        .status-bar { text-align: center; margin-bottom: 10px; font-size: 0.9rem; color: #555; }
        .unsaved-alert { color: #d9534f; font-weight: bold; display: none; margin-left: 10px; }

        /* EDITOR */
        .editor-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #e9ecef; padding: 8px 12px; border: 1px solid #ccc; border-bottom: none;
            border-radius: 6px 6px 0 0;
            flex-wrap: wrap; gap: 5px;
        }
        .toolbar-group { display: flex; gap: 5px; }
        
        .toolbar-btn {
            background: white; border: 1px solid #ccc; padding: 4px 10px; cursor: pointer;
            border-radius: 4px; font-size: 0.85rem; font-weight: bold; color: #333;
        }
        .toolbar-btn:hover { background: #e2e6ea; border-color: #999; }
        .toolbar-btn small { font-weight: normal; color: #666; margin-left: 3px; font-size: 0.8em; }

        textarea#q-text-edit {
            width: 100%;
            height: 350px; /* Taller editor since we have vertical space */
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 0 0 6px 6px;
            font-family: 'Segoe UI', Arial, sans-serif; /* Readable Font */
            font-size: 15px; 
            line-height: 1.5;
            color: #222;
            resize: vertical;
            box-sizing: border-box;
        }
        textarea#q-text-edit:focus { outline: 2px solid var(--light-claret); border-color: var(--light-claret); }

        /* --- RIGHT COLUMN: PREVIEW --- */
        
        .preview-header {
            font-size: 0.85em; text-transform: uppercase; letter-spacing: 1px; color: #777; 
            margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px;
        }

        .preview-box {
            /* Simulating the exam paper look */
            background: #fff;
            padding: 10px;
        }

        /* Rendered Tags */
        .preview-center { text-align: center; }
        
        /* UPDATED: Removed negative indent so the whole block indents cleanly */
        .preview-statement { 
            padding-left: 40px; 
            margin: 10px 0;
            line-height: 1.6;
        }

        .question-img { display: block; max-width: 100%; margin: 15px auto; border-radius: 4px; }
        .option-img { max-width: 150px; vertical-align: middle; }
        
        .options-list { display: grid; gap: 10px; margin-top: 20px; }
        .opt-item { 
            padding: 12px 15px; border: 1px solid #ccc; border-radius: 6px; 
            background: white; display: flex; align-items: center; 
        }
        .opt-item.correct { border-color: var(--success-green); background-color: #f0fff4; color: #155724; }
        
        /* Setup Screen */
        #setup-panel { text-align: center; padding: 60px; max-width: 600px; margin: 40px auto; }

        /* Responsive collapse for small screens */
        @media (max-width: 1000px) {
            .app-grid { grid-template-columns: 1fr; }
        }
        /* Table Formatting */
        .preview-table {
            width: 75%;
            margin: 10px auto;
            border-collapse: collapse;
            font-size: 0.9em;
        }
        .preview-table th {
            background-color: white;
            color: black;
            padding: 8px;
            border: 1px solid black;
        }
        .preview-table td {
            padding: 8px;
            border: 1px solid black;
            text-align: center;
        }
        /* --- UNIFIED TABLE STYLES (Options) --- */
        .combined-table-container {
            border: 2px solid var(--black);
            border-radius: 8px;
            overflow: hidden;
            background-color: var(--white);
            margin-top: 20px;
        }

        .table-row-item {
            display: grid;
            border-bottom: 1px solid black;
            cursor: pointer;
            transition: background 0.1s;
        }
        .table-row-item:last-child { border-bottom: none; }
        .table-row-item:hover { background-color: var(--pale-violet); }
        /* Note: Tagger uses .opt-item.correct, Main App uses .table-row-item.correct/wrong */
        .table-row-item.correct { background-color: #d4edda; color: #155724; } 
        .table-row-item.wrong { background-color: #f8d7da; color: #721c24; }

        .table-header-row {
            display: grid;
            border-bottom: 2px solid var(--black);
            background-color: var(--white);
            font-weight: bold;
        }

        .table-letter-cell {
            background-color: var(--pale-violet);
            color: var(--claret);
            font-weight: bold;
            display: flex; align-items: center; justify-content: center;
            border-right: 1px solid black;
        }

        .table-data-cell {
            padding: 10px;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
            border-right: 1px solid black;
        }
        .table-data-cell:last-child { border-right: none; }

        .header-content-cell {
            background-color: var(--pale-violet);
            color: var(--black);
            padding: 10px;
            display: flex; align-items: center; justify-content: center;
            text-align: center;
            border-right: 1px solid black;
        }
        .header-content-cell:last-child { border-right: none; }

        .header-empty-cell { background-color: transparent; }
    </style>
</head>
<body>

<div class="container">

    <div id="setup-panel" class="card">
        <h1 style="color:var(--claret);">Question Tagger</h1>
        <p>Upload your <code>questions.csv</code> to begin.</p>
        <input type="file" id="csv-file" accept=".csv" style="margin-top:20px;">
    </div>

    <div id="tagging-interface" style="display:none;">
        
        <div class="app-grid">
            
            <div class="col-left">
                
                <div class="card">
                    <div class="status-bar">
                        <span id="progress-text">Loading...</span>
                        <span id="unsaved-warning" class="unsaved-alert">‚ö†Ô∏è Unsaved</span>
                    </div>

                    <div class="nav-grid">
                        <button class="nav-btn" onclick="changeQuestion(-1)">‚¨Ö Prev</button>
                        <button class="save-btn" onclick="downloadCSV()">üíæ Save CSV</button>
                        <button class="nav-btn" onclick="changeQuestion(1)">Next ‚û°</button>
                    </div>

                    <div class="dropdown-grid">
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold; color:#666;">Unit</label>
                            <select id="unit-select">
                                <option value="">-- Select --</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold; color:#666;">Topic</label>
                            <select id="topic-select">
                                <option value="">-- Select --</option>
                            </select>
                        </div>
                        <div>
                            <label style="font-size:0.8rem; font-weight:bold; color:#666;">No.</label>
                            <input type="text" id="number-input" placeholder="#">
                        </div>
                    </div>
                    
                    <div style="margin-top:15px; background: #fffdf5; border: 1px solid #e0e0e0; padding: 8px; border-radius: 6px;">
                        <label style="font-size:0.9rem; font-weight:bold; color:#555; display:flex; align-items:center; cursor:pointer;">
                            <input type="checkbox" id="amark-check" style="width:20px; height:20px; margin-right:10px; accent-color:var(--claret);">
                            'A' Mark (Question is A-grade difficulty)
                        </label>
                    </div>

                    <div style="margin-top:15px;">
                        <label style="font-size:0.8rem; font-weight:bold; color:#666;">Jump to Untagged</label>
                        <select id="untagged-select" onchange="jumpToUntagged(this.value)" style="border-color:var(--amber); background:#fffdf5;">
                            <option value="">-- Select Question --</option>
                        </select>
                    </div>
                </div>

                <div class="card" style="padding:0; overflow:hidden;">
                    <div class="editor-header">
                        <span style="font-weight:bold; color:#555;">Question Text</span>
                        <div class="toolbar-group">
                            <button class="toolbar-btn" onclick="applyTag('c')" title="Alt+C">‚´π‚´∫ Center</button>
                            <button class="toolbar-btn" onclick="applyTag('s')" title="Alt+S">‚â° List</button>
                            <button class="toolbar-btn" onclick="applyTag('t')" title="Alt+T">‚ñ¶ Table</button>
                            <button class="toolbar-btn" onclick="insertAtCursor('<br>')" title="Alt+L">‚Üµ Break</button>
                            <button class="toolbar-btn" onclick="insertAtCursor('&nbsp;')" title="Alt+N">_ NBSP</button>
                        </div>
                    </div>
                    <textarea id="q-text-edit" spellcheck="true"></textarea>
                </div>

            </div>

            <div class="col-right">
                <div class="card">
                    <div class="preview-header">
                        Live Preview (ID: <span id="q-id-display"></span>)
                    </div>
                    
                    <div id="q-preview" class="preview-box"></div>
                    
                    <div id="q-image-area"></div>
                    <div id="options-area" class="options-list"></div>
                </div>
            </div>

        </div>
    </div>
</div>

<script>
    // --- DATA & CONFIG ---
    let allQuestions = [];
    let currentIndex = 0;
    let unsavedChanges = false;

    // --- INIT ---
    window.onload = function() {
        const unitSel = document.getElementById('unit-select');
        const topicSel = document.getElementById('topic-select');
        const numInput = document.getElementById('number-input');
        // NEW Listener for A-Mark
        const amarkCheck = document.getElementById('amark-check');

        // Populate Units from APP_CONFIG (Loaded via config.js)
        if (typeof APP_CONFIG !== 'undefined' && APP_CONFIG.taxonomyOrder) {
            APP_CONFIG.taxonomyOrder.forEach(unit => {
                const opt = document.createElement('option');
                opt.value = unit; opt.textContent = unit; 
                unitSel.appendChild(opt);
            });
        } else {
            alert("Error: config.js not loaded. Please ensure config.js is in the same folder.");
        }

        // Listeners
        unitSel.addEventListener('change', function() { updateTopicOptions(this.value); saveCurrentTags(); });
        topicSel.addEventListener('change', function() { saveCurrentTags(); });
        numInput.addEventListener('input', function() { saveCurrentTags(); }); 
        amarkCheck.addEventListener('change', function() { saveCurrentTags(); }); // Autosave A-Mark
        document.getElementById('q-text-edit').addEventListener('input', function() { syncText(); });

        // Shortcuts
        document.addEventListener('keydown', function(e) {
            if (document.activeElement === document.getElementById('q-text-edit')) {
                // Wrapper Shortcuts
                if (e.altKey && e.key.toLowerCase() === 'c') { e.preventDefault(); applyTag('c'); }
                if (e.altKey && e.key.toLowerCase() === 's') { e.preventDefault(); applyTag('s'); }
                
                // Insertion Shortcuts
                if (e.altKey && e.key.toLowerCase() === 'l') { e.preventDefault(); insertAtCursor('<br>'); }
                if (e.altKey && e.code === 'Space') { e.preventDefault(); insertAtCursor('&nbsp;'); }
            }
        });
    };

    // --- CSV LOAD ---
    document.getElementById('csv-file').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        Papa.parse(file, {
            header: true, skipEmptyLines: true,
            complete: function(results) {
                // Clean keys/values
                allQuestions = results.data.map(q => {
                    const cleanQ = {};
                    Object.keys(q).forEach(k => {
                        const cleanKey = k.trim();
                        cleanQ[cleanKey] = q[k] ? q[k].trim() : "";
                    });
                    if (!cleanQ.tagged) cleanQ.tagged = "0";
                    if (!cleanQ.number) cleanQ.number = "";
                    
                    // NEW: Ensure 'a mark' column exists in memory
                    // We use bracket notation because of the space in "a mark"
                    if (!cleanQ['a mark']) cleanQ['a mark'] = ""; 
                    
                    return cleanQ;
                });

                document.getElementById('setup-panel').style.display = 'none';
                document.getElementById('tagging-interface').style.display = 'block';
                loadQuestionUI();
            }
        });
    });

    // --- UI LOGIC ---
    function loadQuestionUI() {
        if (allQuestions.length === 0) return;
        const q = allQuestions[currentIndex];

        // ID Display
        document.getElementById('q-id-display').textContent = q.id || currentIndex;

        // Editor
        document.getElementById('q-text-edit').value = q.question_text || "";

        // Dropdowns Logic
        const unitSel = document.getElementById('unit-select');
        const topicSel = document.getElementById('topic-select');
        const numInput = document.getElementById('number-input');
        const amarkCheck = document.getElementById('amark-check');
        
        const unitVal = (q.tagged === "1") ? (q.unit || "") : "";
        const topicVal = (q.tagged === "1") ? (q.topic || "") : "";

        unitSel.value = unitVal;
        updateTopicOptions(unitVal); // Re-populate topics based on unit
        topicSel.value = topicVal;
        
        // Load Number
        numInput.value = q.number || "";
        
        // NEW: Load A-Mark
        // Check if value is "1", set checkbox accordingly
        amarkCheck.checked = (q['a mark'] === "1");

        // Preview
        renderPreview(q.question_text || "");
        renderOptions(q);
        
        updateUntaggedList();
    }

    function updateTopicOptions(unitName) {
        const topicSel = document.getElementById('topic-select');
        topicSel.innerHTML = '<option value="">-- Select --</option>';
        // NEW: Pull from APP_CONFIG.taxonomy
        if (APP_CONFIG.taxonomy && APP_CONFIG.taxonomy[unitName]) {
            APP_CONFIG.taxonomy[unitName].forEach(topic => {
                const opt = document.createElement('option');
                opt.value = topic; opt.textContent = topic;
                topicSel.appendChild(opt);
            });
        }
    }

    function saveCurrentTags() {
        const q = allQuestions[currentIndex];
        const unitVal = document.getElementById('unit-select').value;
        const topicVal = document.getElementById('topic-select').value;
        const numVal = document.getElementById('number-input').value;
        const amarkVal = document.getElementById('amark-check').checked;
        
        q.unit = unitVal; 
        q.topic = topicVal;
        q.number = numVal; 
        
        // NEW: Save A-Mark
        // Save as "1" if checked, blank if not
        q['a mark'] = amarkVal ? "1" : "";
        
        q.tagged = (unitVal && topicVal) ? "1" : "0";
        
        unsavedChanges = true;
        document.getElementById('unsaved-warning').style.display = 'inline';
        updateUntaggedList();
    }

    function syncText() {
        const val = document.getElementById('q-text-edit').value;
        allQuestions[currentIndex].question_text = val;
        renderPreview(val);
        unsavedChanges = true;
        document.getElementById('unsaved-warning').style.display = 'inline';
    }

    // --- TAGGING & INSERTION ---
    function applyTag(tag) {
        const textarea = document.getElementById('q-text-edit');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        const before = text.substring(0, start);
        const selected = text.substring(start, end);
        const after = text.substring(end);
        
        textarea.value = `${before}[${tag}]${selected}[/${tag}]${after}`;
        syncText();
        textarea.focus();
        
        const offset = tag.length + 2; 
        textarea.selectionStart = start + offset;
        textarea.selectionEnd = end + offset;
    }

    function insertAtCursor(insertion) {
        const textarea = document.getElementById('q-text-edit');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const text = textarea.value;
        
        const before = text.substring(0, start);
        const after = text.substring(end);
        
        textarea.value = before + insertion + after;
        syncText();
        textarea.focus();
        
        // Move cursor after insertion
        const newPos = start + insertion.length;
        textarea.selectionStart = newPos;
        textarea.selectionEnd = newPos;
    }

    // --- RENDER ---
    function renderPreview(rawText) {
        let html = rawText;
        const q = allQuestions[currentIndex];
        
        // --- UPDATED MULTI-IMAGE LOGIC ---
        // Supports multiple images separated by '|' in the CSV column
        if (q.question_image) {
            const images = q.question_image.split('|');
            
            images.forEach(img => {
                if (img.trim()) {
                    const imgTag = `<img src="images/${img.trim()}" class="question-img">`;
                    // If a placeholder exists, replace the FIRST occurrence found.
                    // Subsequent iterations will replace subsequent placeholders.
                    if (html.includes('{{IMAGE}}')) {
                        html = html.replace('{{IMAGE}}', imgTag);
                    } else {
                        // If no placeholder left, append to end
                        html += imgTag;
                    }
                }
            });
        }
        // ---------------------------------

        // Tags
        html = html.replace(/\[c\]/g, '<div class="preview-center">');
        html = html.replace(/\[\/c\]/g, '</div>');
        html = html.replace(/\[s\]/g, '<div class="preview-statement">');
        html = html.replace(/\[\/s\]/g, '</div>');
        
        // Table: [t]...[/t]
        html = html.replace(/\[t\](.*?)\[\/t\]/gs, (match, content) => {
            const lines = content.trim().split(/\r?\n|<br\s*\/?>/i).filter(l => l.trim());
            if (lines.length === 0) return "";

            let tableHtml = '<table class="preview-table">';

            // Header (first line)
            const headers = lines[0].split('|');
            tableHtml += '<thead><tr>';
            headers.forEach(h => tableHtml += `<th>${h.trim()}</th>`);
            tableHtml += '</tr></thead><tbody>';

            // Rows (rest of lines)
            for (let i = 1; i < lines.length; i++) {
                const cells = lines[i].split('|');
                tableHtml += '<tr>';
                cells.forEach(c => tableHtml += `<td>${c.trim()}</td>`);
                tableHtml += '</tr>';
            }

            tableHtml += '</tbody></table>';
            return tableHtml;
        });
        
        // Math
        const previewEl = document.getElementById('q-preview');
        previewEl.innerHTML = html;
        renderMathInElement(previewEl, { delimiters: [{left: "$$", right: "$$", display: true}, {left: "\\(", right: "\\)", display: false}] });
    }

    function renderOptions(q) {
        const area = document.getElementById('options-area');
        area.innerHTML = '';
        area.className = ''; // Reset styling

        if (q.table_headers) {
            // === TABLE MODE ===
            const headers = q.table_headers.split('|');
            
            const container = document.createElement('div');
            container.className = 'combined-table-container';

            // 1. Header Row
            const headerRow = document.createElement('div');
            headerRow.className = 'table-header-row';
            headerRow.style.gridTemplateColumns = `50px repeat(${headers.length}, 1fr)`;
            
            // Empty Cell (for the letter column)
            const emptyCell = document.createElement('div');
            emptyCell.className = 'header-empty-cell';
            headerRow.appendChild(emptyCell);

            // Headers
            headers.forEach(h => {
                const cell = document.createElement('div');
                cell.className = 'header-content-cell';
                cell.textContent = h.trim();
                headerRow.appendChild(cell);
            });
            container.appendChild(headerRow);

            // 2. Data Rows (A-E)
            ['option_a', 'option_b', 'option_c', 'option_d', 'option_e'].forEach((key, i) => {
                if (!q[key]) return;
                const letter = String.fromCharCode(65 + i);
                const isCorrect = (letter === q.correct_answer);
                
                const row = document.createElement('div');
                row.className = isCorrect ? 'table-row-item correct' : 'table-row-item';
                row.style.gridTemplateColumns = `50px repeat(${headers.length}, 1fr)`;
                
                // Letter
                const letCell = document.createElement('div');
                letCell.className = 'table-letter-cell';
                letCell.textContent = letter;
                row.appendChild(letCell);

                // Data
                const cells = q[key].split('|');
                cells.forEach(c => {
                    const dCell = document.createElement('div');
                    dCell.className = 'table-data-cell';
                    dCell.textContent = c.trim();
                    row.appendChild(dCell);
                });
                
                renderMathInElement(row);
                container.appendChild(row);
            });
            area.appendChild(container);

        } else {
            // === STANDARD MODE ===
            area.className = 'options-list';
            ['option_a', 'option_b', 'option_c', 'option_d', 'option_e'].forEach((key, i) => {
                if (!q[key]) return;
                const letter = String.fromCharCode(65 + i);
                const isCorrect = (letter === q.correct_answer);
                
                const div = document.createElement('div');
                div.className = isCorrect ? 'opt-item correct' : 'opt-item';
                
                let content = q[key];
                if (content.startsWith('[IMG]')) content = `<img src="images/${content.replace('[IMG]', '')}" class="option-img">`;
                
                div.innerHTML = `<b style="margin-right:10px; min-width:20px;">${letter})</b> <div>${content}</div>`;
                renderMathInElement(div);
                area.appendChild(div);
            });
        }
    }

    // --- NAV ---
    function updateUntaggedList() {
        const sel = document.getElementById('untagged-select');
        sel.innerHTML = '<option value="">-- Jump to Untagged --</option>';
        let count = 0;
        allQuestions.forEach((q, idx) => {
            if (q.tagged === "0") {
                const opt = document.createElement('option');
                opt.value = idx;
                opt.textContent = `${q.year} - Q${q.id.split('-')[1] || idx}`;
                sel.appendChild(opt);
                count++;
            }
        });
        document.getElementById('progress-text').innerHTML = 
            `Question <b>${currentIndex + 1}</b> / ${allQuestions.length} | Untagged: <b style="color:var(--claret)">${count}</b>`;
    }

    function jumpToUntagged(idx) {
        if (idx !== "") { currentIndex = parseInt(idx); loadQuestionUI(); }
    }

    function changeQuestion(dir) {
        const newIdx = currentIndex + dir;
        if (newIdx >= 0 && newIdx < allQuestions.length) { currentIndex = newIdx; loadQuestionUI(); window.scrollTo(0, 0); }
    }

    function downloadCSV() {
        // 1. Define your preferred order
        const standardOrder = [
            "id", 
            "year", 
            "number",
            "unit", 
            "topic", 
            "question_text", 
            "question_image", 
            "table_headers", 
            "option_a", 
            "option_b", 
            "option_c", 
            "option_d", 
            "option_e", 
            "correct_answer", 
            "a mark",
            "tagged" 
        ];

        // 2. Re-map the data to force this order
        const reorderedData = allQuestions.map(q => {
            const newObj = {};
            
            // A. Add the standard columns first
            standardOrder.forEach(key => {
                newObj[key] = q[key] || ""; // Use empty string if missing
            });

            // B. Preserve any 'extra' columns (e.g. notes) that aren't in the list above
            Object.keys(q).forEach(key => {
                if (!standardOrder.includes(key)) {
                    newObj[key] = q[key];
                }
            });

            return newObj;
        });

        // 3. Generate CSV
        const csv = Papa.unparse(reorderedData, { quotes: true });
        const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = "questions.csv"; 
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
        
        unsavedChanges = false;
        document.getElementById('unsaved-warning').style.display = 'none';
    }
</script>

</body>
</html>